<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本文将利用holper disassembler  class dump  窥探KVO背后的原理。">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="KVO">
<meta property="og:url" content="http://yfeii.github.io/2019/08/08/KVO/index.html">
<meta property="og:site_name" content="逆水行舟">
<meta property="og:description" content="本文将利用holper disassembler  class dump  窥探KVO背后的原理。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-08-11T15:06:26.621Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KVO">
<meta name="twitter:description" content="本文将利用holper disassembler  class dump  窥探KVO背后的原理。">





  
  
  <link rel="canonical" href="http://yfeii.github.io/2019/08/08/KVO/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>KVO | 逆水行舟</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逆水行舟</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yfeii.github.io/2019/08/08/KVO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yfeii">
      <meta itemprop="description" content="邮箱1486662452@qq.com，有问题欢迎留言评论或邮件">
      <meta itemprop="image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/profile/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逆水行舟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">KVO

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-08-08 19:01:43" itemprop="dateCreated datePublished" datetime="2019-08-08T19:01:43+08:00">2019-08-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-08-11 23:06:26" itemprop="dateModified" datetime="2019-08-11T23:06:26+08:00">2019-08-11</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS基础/" itemprop="url" rel="index"><span itemprop="name">iOS基础</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">评论数：</span>
                <a href="/2019/08/08/KVO/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/08/KVO/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p> 本文将利用<code>holper disassembler </code> <code>class dump </code> 窥探KVO背后的原理。<a id="more"></a></p>
<p>准备工作</p>
<ul>
<li>holper disassembler</li>
<li>class dump</li>
<li>LLDB 调试指令如：&amp;arg0   symbol breakpoint   (SEL)&amp;arg0  frame 等等 </li>
<li>汇编相关知识。操作符 寄存器等  </li>
</ul>
<p>希望解决的问题</p>
<ul>
<li>KVO注册期间发生经过了什么，内部组成是什么</li>
<li>KVO如何实现弱引用</li>
<li>KVO的observationInfo如何实现<h2 id="Foundation-framework"><a href="#Foundation-framework" class="headerlink" title="Foundation.framework"></a>Foundation.framework</h2>通过class dump 查看 Foundation.framework 的目录结构及对象结构,<a href="http://iphonedevwiki.net/index.php/Foundation.framework/Inheritance_hierarchy" target="_blank" rel="noopener">这里有一篇继承结构说明</a></li>
</ul>
<p>通过<code>holper disassembler </code> 反编译 Foundation.framework 的可执行文件，切记不是.tdb结尾的文件。反编译成功后，搜索“addObserver”关键字，可便看见如下方法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> -[NSObject addObserver:forKeyPath:options:context:](<span class="keyword">void</span> * self, <span class="keyword">void</span> * _cmd, <span class="keyword">void</span> * arg2, <span class="keyword">void</span> * arg3, unsigned long long arg4, <span class="keyword">void</span> * arg5) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 参数说明 self, _cmd 对应OC的方法中target selector，</span></span><br><span class="line"><span class="comment">     * arg2:observer对象</span></span><br><span class="line"><span class="comment">     * arg3:path</span></span><br><span class="line"><span class="comment">     * arg4:options</span></span><br><span class="line"><span class="comment">     * arg5:context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    pthread_mutex_lock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">    *__NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">    rax = object_getClass(self);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取NSKeyValueUnnestedProperty（继承与NSKeyValueProperty） 对象</span></span><br><span class="line">    rax = _NSKeyValuePropertyForIsaAndKeyPath(rax, arg3, arg2);</span><br><span class="line">    <span class="comment">//真正的方法</span></span><br><span class="line">    [self _addObserver:arg2 forProperty:rax options:arg4 context:arg5];</span><br><span class="line">    *__NSKeyValueObserverRegistrationLockOwner = <span class="number">0x0</span>;</span><br><span class="line">    pthread_mutex_unlock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x0</span> != <span class="number">0x0</span>) &#123;</span><br><span class="line">    </span><br><span class="line">       objc_exception_rethrow();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="NSKeyValueProperty"><a href="#NSKeyValueProperty" class="headerlink" title="NSKeyValueProperty"></a>NSKeyValueProperty</h3><p><a href="https://github.com/yFeii/iOS-Runtime-Headers/blob/master/Frameworks/Foundation.framework/NSKeyValueProperty.h" target="_blank" rel="noopener">NSKeyValueProperty对象结构</a>，<a href="https://github.com/yFeii/iOS-Runtime-Headers/blob/master/Frameworks/Foundation.framework/NSKeyValueUnnestedProperty.h" target="_blank" rel="noopener">NSKeyValueUnnestedProperty对象结构</a></p>
<h4 id="获取NSKeyValueProperty对象"><a href="#获取NSKeyValueProperty对象" class="headerlink" title="获取NSKeyValueProperty对象"></a>获取NSKeyValueProperty对象</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">_NSKeyValuePropertyForIsaAndKeyPath(int arg0, int arg1, int arg2)&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * arg0: isa</span></span><br><span class="line"><span class="comment">     * arg1: keyPath</span></span><br><span class="line"><span class="comment">     * arg2: observer对象</span></span><br><span class="line"><span class="comment">     * _NSKeyValueProperties 为全局CFMutableSetRef</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">    r14 = arg1;</span><br><span class="line">    r15 = arg0;</span><br><span class="line">    var_40 = <span class="number">0x0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取NSKeyValueContainerClass</span></span><br><span class="line">    var_38 = __NSKeyValueContainerClassForIsa(arg0, arg1, arg2);</span><br><span class="line">    var_30 = r14;</span><br><span class="line">    <span class="comment">// _NSKeyValueProperties 为缓存 NSKeyValueProperty的set</span></span><br><span class="line">    <span class="keyword">if</span> (*_NSKeyValueProperties != <span class="number">0x0</span>) &#123;</span><br><span class="line">            rax = CFSetGetValue(*_NSKeyValueProperties, <span class="number">0x0</span>);</span><br><span class="line">            rbx = rax;</span><br><span class="line">            <span class="comment">//如果 NSKeyValueProperty不存在</span></span><br><span class="line">            <span class="keyword">if</span> (rax == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    *(var_70 + <span class="number">0x18</span>) = *_kOSThermalNotificationPressureLevelName;</span><br><span class="line">                    *(var_70 + <span class="number">0x10</span>) = *_kIOMasterPortDefault;</span><br><span class="line">                    rcx = *_kCFTypeSetCallBacks;</span><br><span class="line">                    *(var_70 + <span class="number">0x8</span>) = *_kCFURLIsRegularFileKey;</span><br><span class="line">                    *var_70 = rcx;</span><br><span class="line">                    *(var_70 + <span class="number">0x20</span>) = _NSKeyValuePropertyIsEqual;</span><br><span class="line">                    *(var_70 + <span class="number">0x28</span>) = _NSKeyValuePropertyHash;</span><br><span class="line">                    rax = CFSetCreateMutable(<span class="number">0x0</span>, <span class="number">0x0</span>, var_70);</span><br><span class="line">                    <span class="comment">// 根据 isa keyPath CFSet来决定实例化哪种NSKeyValueProperty（下面三种）</span></span><br><span class="line">                    <span class="comment">// NSKeyValueNestedProperty NSKeyValueUnnestedProperty NSKeyValueComputedProperty</span></span><br><span class="line">                    rbx = _NSKeyValuePropertyForIsaAndKeyPathInner(r15, r14, rax);</span><br><span class="line">                    rax = CFRelease(rax);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">0x0</span> == <span class="number">0x0</span>) &#123;</span><br><span class="line">                            rax = rbx;</span><br><span class="line">                            rbx = stack[<span class="number">2042</span>];</span><br><span class="line">                            r12 = stack[<span class="number">2043</span>];</span><br><span class="line">                            r13 = stack[<span class="number">2044</span>];</span><br><span class="line">                            r14 = stack[<span class="number">2045</span>];</span><br><span class="line">                            r15 = stack[<span class="number">2046</span>];</span><br><span class="line">                            rsp = rsp + <span class="number">0x78</span>;</span><br><span class="line">                            rbp = stack[<span class="number">2047</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                            rax = objc_exception_rethrow();</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    rax = rbx;</span><br><span class="line">                    rbx = stack[<span class="number">2042</span>];</span><br><span class="line">                    r12 = stack[<span class="number">2043</span>];</span><br><span class="line">                    r13 = stack[<span class="number">2044</span>];</span><br><span class="line">                    r14 = stack[<span class="number">2045</span>];</span><br><span class="line">                    r15 = stack[<span class="number">2046</span>];</span><br><span class="line">                    rsp = rsp + <span class="number">0x78</span>;</span><br><span class="line">                    rbp = stack[<span class="number">2047</span>];</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            *(var_70 + <span class="number">0x18</span>) = *_kOSThermalNotificationPressureLevelName;</span><br><span class="line">            *(var_70 + <span class="number">0x10</span>) = *_kIOMasterPortDefault;</span><br><span class="line">            rcx = *_kCFTypeSetCallBacks;</span><br><span class="line">            *(var_70 + <span class="number">0x8</span>) = *_kCFURLIsRegularFileKey;</span><br><span class="line">            *var_70 = rcx;</span><br><span class="line">            *(var_70 + <span class="number">0x20</span>) = _NSKeyValuePropertyIsEqual;</span><br><span class="line">            *(var_70 + <span class="number">0x28</span>) = _NSKeyValuePropertyHash;</span><br><span class="line">            rax = CFSetCreateMutable(<span class="number">0x0</span>, <span class="number">0x0</span>, var_70);</span><br><span class="line">            <span class="comment">//同上面 “_NSKeyValuePropertyForIsaAndKeyPathInner”</span></span><br><span class="line">            rbx = _NSKeyValuePropertyForIsaAndKeyPathInner(r15, r14, rax);</span><br><span class="line">            rax = CFRelease(rax);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x0</span> == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    rax = rbx;</span><br><span class="line">                    rbx = stack[<span class="number">2042</span>];</span><br><span class="line">                    r12 = stack[<span class="number">2043</span>];</span><br><span class="line">                    r13 = stack[<span class="number">2044</span>];</span><br><span class="line">                    r14 = stack[<span class="number">2045</span>];</span><br><span class="line">                    r15 = stack[<span class="number">2046</span>];</span><br><span class="line">                    rsp = rsp + <span class="number">0x78</span>;</span><br><span class="line">                    rbp = stack[<span class="number">2047</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    rax = objc_exception_rethrow();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rax;</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NSKeyValueContainerClass"><a href="#NSKeyValueContainerClass" class="headerlink" title="NSKeyValueContainerClass"></a>NSKeyValueContainerClass</h3><p>NSKeyValueContainerClass<a href="https://github.com/nst/iOS-Runtime-Headers/blob/master/Frameworks/Foundation.framework/NSKeyValueContainerClass.h" target="_blank" rel="noopener">类结构</a></p>
<h4 id="获取NSKeyValueContainerClass"><a href="#获取NSKeyValueContainerClass" class="headerlink" title="获取NSKeyValueContainerClass"></a>获取NSKeyValueContainerClass</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">int __NSKeyValueContainerClassForIsa(int arg0, int arg1, int arg2) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * arg0: isa</span></span><br><span class="line"><span class="comment">     * arg1: keyPath</span></span><br><span class="line"><span class="comment">     * arg2: observer对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * 这里面多次出现的“*__NSKeyValueContainerClassForIsa”,其实是局部的静态变量</span></span><br><span class="line"><span class="comment">      * 所以 NSKeyValueContainerClassPerOriginalClass 就是一个static 的CFMutableDictionary</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    rdx = arg2;</span><br><span class="line">    rsi = arg1;</span><br><span class="line">    <span class="comment">//如果缓存的Key 与 isa 不一致，注意这里的isa可能是"NSKVONotifying_"也可能是原类，在第二次添加时则为派生类</span></span><br><span class="line">    <span class="keyword">if</span> (*__NSKeyValueContainerClassForIsa.isaCacheKey != arg0) &#123;</span><br><span class="line">            rdi = *__NSKeyValueContainerClassForIsa.NSKeyValueContainerClassPerOriginalClass;</span><br><span class="line">            r15 = rdi;</span><br><span class="line">            <span class="comment">//获得原类的 isa,里面会判断根据“isKVOA”方法的实现来判断返回原类</span></span><br><span class="line">            r14 = __NSKVONotifyingOriginalClassForIsa(rdi);</span><br><span class="line">            <span class="comment">// 如果存在缓存</span></span><br><span class="line">            <span class="keyword">if</span> (*__NSKeyValueContainerClassForIsa.NSKeyValueContainerClassPerOriginalClass != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    <span class="comment">//根据isa 取出 NSKeyValueContainerClass</span></span><br><span class="line">                    rax = CFDictionaryGetValue(*__NSKeyValueContainerClassForIsa.NSKeyValueContainerClassPerOriginalClass, r14);</span><br><span class="line">                    rbx = rax;</span><br><span class="line">                    <span class="comment">//取不到</span></span><br><span class="line">                    <span class="keyword">if</span> (rax == <span class="number">0x0</span>) &#123;</span><br><span class="line">                            <span class="comment">//初始化 NSKeyValueContainerClass 对象 并存入缓存</span></span><br><span class="line">                            r12 = _objc_msgSend;</span><br><span class="line">                            rax = [NSKeyValueContainerClass alloc];</span><br><span class="line">                            rax = [rax initWithOriginalClass:r14];</span><br><span class="line">                            rbx = rax;</span><br><span class="line">                            rax = CFDictionarySetValue(*__NSKeyValueContainerClassForIsa.NSKeyValueContainerClassPerOriginalClass, r14, rax);</span><br><span class="line">                            rax = [rbx release];</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// 如果不存在缓存，则初始化静态变量NSKeyValueContainerClassPerOriginalClass（CFMutableDictionary）</span></span><br><span class="line">                    *__NSKeyValueContainerClassForIsa.NSKeyValueContainerClassPerOriginalClass = CFDictionaryCreateMutable(<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, _kCFTypeDictionaryValueCallBacks);</span><br><span class="line">                    r12 = _objc_msgSend;</span><br><span class="line">                    <span class="comment">//初始化 NSKeyValueContainerClass 对象 并存入缓存</span></span><br><span class="line">                    rax = [NSKeyValueContainerClass alloc];</span><br><span class="line">                    rax = [rax initWithOriginalClass:r14];</span><br><span class="line">                    rbx = rax;</span><br><span class="line">                    rax = CFDictionarySetValue(*__NSKeyValueContainerClassForIsa.NSKeyValueContainerClassPerOriginalClass, r14, rax);</span><br><span class="line">                    rax = [rbx release];</span><br><span class="line">            &#125;</span><br><span class="line">            更新静态变量缓存的值</span><br><span class="line">            *__NSKeyValueContainerClassForIsa.isaCacheKey = r15;</span><br><span class="line">            *__NSKeyValueContainerClassForIsa.cachedContainerClass = rbx;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//cacheKey 相同 则直接返回 cachedContainerClass</span></span><br><span class="line">            rbx = *__NSKeyValueContainerClassForIsa.cachedContainerClass;</span><br><span class="line">    &#125;</span><br><span class="line">    rax = rbx;</span><br><span class="line">    rbx = stack[<span class="number">2043</span>];</span><br><span class="line">    r12 = stack[<span class="number">2044</span>];</span><br><span class="line">    r14 = stack[<span class="number">2045</span>];</span><br><span class="line">    r15 = stack[<span class="number">2046</span>];</span><br><span class="line">    rsp = rsp + <span class="number">0x28</span>;</span><br><span class="line">    rbp = stack[<span class="number">2047</span>];</span><br><span class="line">    <span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过上面两步准备工作之后，会调用下的方法并传入准备好的<code>NSKeyValueProperty</code>，其中部分枚举定义可参考NSKeyValueObserving.h</p>
<h3 id="addObserver真正的实现"><a href="#addObserver真正的实现" class="headerlink" title="_addObserver真正的实现"></a>_addObserver真正的实现</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> -[NSObject _addObserver:forProperty:options:context:](<span class="keyword">void</span> * self, <span class="keyword">void</span> * _cmd, <span class="keyword">void</span> * arg2, <span class="keyword">void</span> * arg3, unsigned long long arg4, <span class="keyword">void</span> * arg5) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * arg2: observer对象</span></span><br><span class="line"><span class="comment">     * arg3: NSKeyValueProperty子类对象</span></span><br><span class="line"><span class="comment">     * arg4: options</span></span><br><span class="line"><span class="comment">     * arg5: context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     </span><br><span class="line">    rsi = _cmd;</span><br><span class="line">    var_40 = arg5;</span><br><span class="line">    r12 = arg4;</span><br><span class="line">    r13 = arg3;</span><br><span class="line">    var_38 = arg2;</span><br><span class="line">    r14 = self;</span><br><span class="line">    <span class="comment">// 0x4 为枚举 NSKeyValueObservingOptionInitial</span></span><br><span class="line">    <span class="keyword">if</span> ((r12 &amp; <span class="number">0x4</span>) != <span class="number">0x0</span>) &#123;</span><br><span class="line">            var_30 = <span class="number">0x0</span>;</span><br><span class="line">            <span class="comment">//取出 property 的 keyPath</span></span><br><span class="line">            r15 = [r13 keyPath];</span><br><span class="line">            *__NSKeyValueObserverRegistrationLockOwner = <span class="number">0x0</span>;</span><br><span class="line">            rax = pthread_mutex_unlock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">            <span class="comment">// 0x1 NSKeyValueObservingOptionNew</span></span><br><span class="line">            <span class="keyword">if</span> ((r12 &amp; <span class="number">0x1</span>) == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    <span class="comment">//初始化值</span></span><br><span class="line">                    rax = <span class="number">0x0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// [self valueForKeyPath:keyPath]</span></span><br><span class="line">                    rax = [r14 valueForKeyPath:r15];</span><br><span class="line">                    <span class="keyword">if</span> (rax == <span class="number">0x0</span>) &#123;</span><br><span class="line">                            rax = [NSNull <span class="literal">null</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stack[<span class="number">2031</span>] = <span class="number">0x0</span>;</span><br><span class="line">            stack[<span class="number">2030</span>] = <span class="number">0x0</span>;</span><br><span class="line">            stack[<span class="number">2029</span>] = rax;</span><br><span class="line">            stack[<span class="number">2028</span>] = <span class="number">0x0</span>;</span><br><span class="line">            stack[<span class="number">2032</span>] = <span class="number">0x0</span>;</span><br><span class="line">            <span class="comment">// NSKeyValueObservingOptionInitial 时 发送通知</span></span><br><span class="line">            rax = _NSKeyValueNotifyObserver(var_38, <span class="number">0x0</span>, r14, var_40, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x1</span>);</span><br><span class="line">            r15 = <span class="number">0x0</span>;</span><br><span class="line">            rax = [<span class="number">0x0</span> release];</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x1</span> != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    rax = pthread_mutex_lock(__NSKeyValueObserverRegistrationLock);</span><br><span class="line">                    *__NSKeyValueObserverRegistrationLockOwner = pthread_self();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x0</span> == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 获取oldObservationInfo 内部会根据containerClass是否缓存了“observationInfo”</span></span><br><span class="line">                    <span class="comment">//来调用cachedObservationInfoImplementation 或者 直接获取object的observationInfo对象</span></span><br><span class="line">                    r15 = __NSKeyValueRetainedObservationInfoForObject(r14, r13-&gt;_containerClass);</span><br><span class="line">                    <span class="keyword">if</span> (!(BIT_TEST(r12, <span class="number">0x8</span>))) &#123;</span><br><span class="line">                            rax = _CFGetTSD(<span class="number">0x15</span>);</span><br><span class="line">                            <span class="keyword">if</span> (rax != <span class="number">0x0</span>) &#123;</span><br><span class="line">                                    r9 = *(rax + <span class="number">0x10</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                    r9 = <span class="number">0x0</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                            r9 = <span class="number">0x0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//  获取newObservationInfo ，创建逻辑 下面有说明</span></span><br><span class="line">                    r12 = __NSKeyValueObservationInfoCreateByAdding(r15, var_38, r13, r12, var_40, r9, <span class="number">0x0</span>, <span class="number">0x1</span>);</span><br><span class="line">                    r8 = <span class="number">0x0</span>;</span><br><span class="line">                    <span class="comment">// 通过遍历替换老的ObservationInfo</span></span><br><span class="line">                    rax = __NSKeyValueReplaceObservationInfoForObject(r14, r13-&gt;_containerClass, r15, r12);</span><br><span class="line">                    rax = [r13 object:r14 didAddObservance:*<span class="number">0x1</span> recurse:<span class="number">0x1</span>];</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 核心方法: 获取property中已经修改过的class，这里会完成对原类一些方法的复写，这里不再说明（因为结果网上一大把- -）</span></span><br><span class="line">                    rax = [r13 isaForAutonotifying];</span><br><span class="line">                    rbx = rax;</span><br><span class="line">                    <span class="keyword">if</span> ((rax != <span class="number">0x0</span>) &amp;&amp; (object_getClass(r14) != rbx)) &#123;</span><br><span class="line">                            <span class="comment">// 通过 object_setClass()修改isa指针, 设置自己的class为property的isaForAutonotifying</span></span><br><span class="line">                            rax = object_setClass(r14, rbx);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r13 = <span class="number">0x0</span>;</span><br><span class="line">                    rbx = @selector(release);</span><br><span class="line">                    rax = _objc_msgSend(r12, rbx);</span><br><span class="line">                    <span class="keyword">if</span> (r15 != <span class="number">0x0</span>) &#123;</span><br><span class="line">                            rax = _objc_msgSend(r15, rbx);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="number">0x0</span> == <span class="number">0x0</span>) &#123;</span><br><span class="line">                            rbx = stack[<span class="number">2042</span>];</span><br><span class="line">                            r12 = stack[<span class="number">2043</span>];</span><br><span class="line">                            r13 = stack[<span class="number">2044</span>];</span><br><span class="line">                            r14 = stack[<span class="number">2045</span>];</span><br><span class="line">                            r15 = stack[<span class="number">2046</span>];</span><br><span class="line">                            rsp = rsp + <span class="number">0xa8</span>;</span><br><span class="line">                            rbp = stack[<span class="number">2047</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                            rax = objc_exception_rethrow();</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    rax = objc_exception_rethrow();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 大部分都是跟上面一样的逻辑 这里不再赘述</span></span><br><span class="line">            r15 = __NSKeyValueRetainedObservationInfoForObject(r14, r13-&gt;_containerClass);</span><br><span class="line">            <span class="keyword">if</span> (!(BIT_TEST(r12, <span class="number">0x8</span>))) &#123;</span><br><span class="line">                    rax = _CFGetTSD(<span class="number">0x15</span>);</span><br><span class="line">                    <span class="keyword">if</span> (rax != <span class="number">0x0</span>) &#123;</span><br><span class="line">                            r9 = *(rax + <span class="number">0x10</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                            r9 = <span class="number">0x0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    r9 = <span class="number">0x0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            r12 = __NSKeyValueObservationInfoCreateByAdding(r15, var_38, r13, r12, var_40, r9, <span class="number">0x0</span>, <span class="number">0x1</span>);</span><br><span class="line">            r8 = <span class="number">0x0</span>;</span><br><span class="line">            rax = __NSKeyValueReplaceObservationInfoForObject(r14, r13-&gt;_containerClass, r15, r12);</span><br><span class="line">            rax = [r13 object:r14 didAddObservance:*<span class="number">0x1</span> recurse:<span class="number">0x1</span>];</span><br><span class="line">            rax = [r13 isaForAutonotifying];</span><br><span class="line">            rbx = rax;</span><br><span class="line">            <span class="keyword">if</span> ((rax != <span class="number">0x0</span>) &amp;&amp; (object_getClass(r14) != rbx)) &#123;</span><br><span class="line">                    rax = object_setClass(r14, rbx);</span><br><span class="line">            &#125;</span><br><span class="line">            r13 = <span class="number">0x0</span>;</span><br><span class="line">            rbx = @selector(release);</span><br><span class="line">            rax = _objc_msgSend(r12, rbx);</span><br><span class="line">            <span class="keyword">if</span> (r15 != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    rax = _objc_msgSend(r15, rbx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x0</span> == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    rbx = stack[<span class="number">2042</span>];</span><br><span class="line">                    r12 = stack[<span class="number">2043</span>];</span><br><span class="line">                    r13 = stack[<span class="number">2044</span>];</span><br><span class="line">                    r14 = stack[<span class="number">2045</span>];</span><br><span class="line">                    r15 = stack[<span class="number">2046</span>];</span><br><span class="line">                    rsp = rsp + <span class="number">0xa8</span>;</span><br><span class="line">                    rbp = stack[<span class="number">2047</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    rax = objc_exception_rethrow();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="NSKeyValueObserverInfo"><a href="#NSKeyValueObserverInfo" class="headerlink" title="NSKeyValueObserverInfo"></a>NSKeyValueObserverInfo</h4><p>创建NSKeyValueObserverInfo的逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">int __NSKeyValueObservationInfoCreateByAdding(int arg0, int arg1, int arg2, int arg3, int arg4, int arg5, int arg6, int arg7) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * arg0: NSKeyValueObservationInfo 对象</span></span><br><span class="line"><span class="comment">    * arg1: observer 对象</span></span><br><span class="line"><span class="comment">    * arg2: NSKeyValueProperty 对象</span></span><br><span class="line"><span class="comment">    * arg3: options</span></span><br><span class="line"><span class="comment">    * arg4: context</span></span><br><span class="line"><span class="comment">    * arg5: originalObservable</span></span><br><span class="line"><span class="comment">    * arg6: cacheHit</span></span><br><span class="line"><span class="comment">    * arg7: addedObservance</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    var_48 = arg5;</span><br><span class="line">    r12 = arg4;</span><br><span class="line">    r15 = arg3;</span><br><span class="line">    var_40 = arg2;</span><br><span class="line">    rbx = arg1;</span><br><span class="line">    r14 = arg0;</span><br><span class="line">    os_unfair_lock_lock_with_options(_NSKeyValueObservationInfoCreationLock, <span class="number">0x10000</span>, arg2, arg3, arg4, arg5, stack[<span class="number">2035</span>], stack[<span class="number">2036</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用弱引用表NSKeyValueShareableObservationInfos缓存观察者对象</span></span><br><span class="line">    <span class="keyword">if</span> (*_NSKeyValueShareableObservationInfos == <span class="number">0x0</span>) &#123;</span><br><span class="line">            var_30 = r12;</span><br><span class="line">            rax = [NSPointerFunctions alloc];</span><br><span class="line">            rax = [rax initWithOptions:<span class="number">0x5</span>];</span><br><span class="line">            r13 = rax;</span><br><span class="line">            [rax setHashFunction:_NSKeyValueShareableObservationInfoNSHTHash];</span><br><span class="line">            [r13 setIsEqualFunction:_NSKeyValueShareableObservationInfoNSHTIsEqual];</span><br><span class="line">            r14 = r14;</span><br><span class="line">            rbx = rbx;</span><br><span class="line">            *_NSKeyValueShareableObservationInfos = [[NSHashTable alloc] initWithPointerFunctions:r13 capacity:<span class="number">0x0</span>];</span><br><span class="line">            [r13 release];</span><br><span class="line">            r12 = var_30;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// isa不存在初始化 NSKeyValueShareableObservationInfoKey 并记录isa</span></span><br><span class="line">    <span class="keyword">if</span> (*_NSKeyValueShareableObservationInfoKeyIsa == <span class="number">0x0</span>) &#123;</span><br><span class="line">            *_NSKeyValueShareableObservationInfoKeyIsa = [NSKeyValueShareableObservationInfoKey self];</span><br><span class="line">    &#125;</span><br><span class="line">    rdx = *__NSKeyValueObservationInfoCreateByAdding.shareableObservationInfoKey;</span><br><span class="line">    <span class="keyword">if</span> (rdx == <span class="number">0x0</span>) &#123;</span><br><span class="line">            r13 = rbx;</span><br><span class="line">            rbx = r15;</span><br><span class="line">            rax = [NSKeyValueShareableObservationInfoKey alloc];</span><br><span class="line">            rax = [rax init];</span><br><span class="line">            r15 = rbx;</span><br><span class="line">            rbx = r13;</span><br><span class="line">            rdx = rax;</span><br><span class="line">            *__NSKeyValueObservationInfoCreateByAdding.shareableObservationInfoKey = rax;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上下这几行 是建立索引条件，_NSKeyValueShareableObservationInfos 将以这些参数判断是否存在老的NSKeyValueObservationInfo</span></span><br><span class="line">    rdx-&gt;_addingNotRemoving = <span class="number">0x1</span>;</span><br><span class="line">    rdx-&gt;_baseObservationInfo = r14;</span><br><span class="line">    rdx-&gt;_additionObserver = rbx;</span><br><span class="line">    rdx-&gt;_additionProperty = var_40;</span><br><span class="line">    rdx-&gt;_additionOptions = r15 &amp; <span class="number">0xfffffffffffffffb</span>;</span><br><span class="line">    rdx-&gt;_additionContext = r12;</span><br><span class="line">    rdx-&gt;_additionOriginalObservable = var_48;</span><br><span class="line">    r13 = rbx;</span><br><span class="line">    rbx = r14;</span><br><span class="line">    rsi = r12;</span><br><span class="line">    <span class="comment">//查找缓存里 是否已经包含 和  baseObservationInfo + observance(observer, property, options, context) 一样的 observationInfo</span></span><br><span class="line">    <span class="comment">//避免不必要的创建</span></span><br><span class="line">    r12 = [*_NSKeyValueShareableObservationInfos member:rdx];</span><br><span class="line">    rax = *__NSKeyValueObservationInfoCreateByAdding.shareableObservationInfoKey;</span><br><span class="line">    rax-&gt;_additionOriginalObservable = <span class="number">0x0</span>;</span><br><span class="line">    rax-&gt;_additionObserver = <span class="number">0x0</span>;</span><br><span class="line">    rax-&gt;_baseObservationInfo = <span class="number">0x0</span>;</span><br><span class="line">    <span class="comment">//如果存在缓存</span></span><br><span class="line">    <span class="keyword">if</span> (r12 != <span class="number">0x0</span>) &#123;</span><br><span class="line">            <span class="comment">//observance必定就是已存在的info.observance列表最后一个， 因为判断equal就是按照这个原则去判断的</span></span><br><span class="line">            [r12 retain];</span><br><span class="line">            *(int8_t *)arg6 = <span class="number">0x1</span>;</span><br><span class="line">            *arg7 = [r12-&gt;_observances lastObject];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不存在初始化 _NSKeyValueShareableObservances 缓存</span></span><br><span class="line">            r12 = r13;</span><br><span class="line">            r14 = r15;</span><br><span class="line">            r13 = rsi;</span><br><span class="line">            var_30 = rbx;</span><br><span class="line">            rdi = *_NSKeyValueShareableObservances;</span><br><span class="line">            <span class="keyword">if</span> (rdi == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    rax = [NSHashTable weakObjectsHashTable];</span><br><span class="line">                    rax = [rax retain];</span><br><span class="line">                    rdi = rax;</span><br><span class="line">                    *_NSKeyValueShareableObservances = rax;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 跟 shareableObservationInfoKey 同样的逻辑，初始化_NSKeyValueShareableObservances的查找条件</span></span><br><span class="line">            rdx = *__NSKeyValueObservationInfoCreateByAdding.shareableObservanceKey;</span><br><span class="line">            rcx = var_40;</span><br><span class="line">            <span class="keyword">if</span> (rdx == <span class="number">0x0</span>) &#123;</span><br><span class="line">                    rax = [NSKeyValueShareableObservanceKey alloc];</span><br><span class="line">                    rax = [rax init];</span><br><span class="line">                    rcx = rcx;</span><br><span class="line">                    rdx = rax;</span><br><span class="line">                    *__NSKeyValueObservationInfoCreateByAdding.shareableObservanceKey = rax;</span><br><span class="line">                    rdi = *_NSKeyValueShareableObservances;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//同上</span></span><br><span class="line">            r15 = r12;</span><br><span class="line">            rdx-&gt;_observer = r12;</span><br><span class="line">            rdx-&gt;_property = rcx;</span><br><span class="line">            rdx-&gt;_options = rdx-&gt;_options &amp; <span class="number">0x80</span> | r14 &amp; <span class="number">0x7b</span>;</span><br><span class="line">            rdx-&gt;_context = r13;</span><br><span class="line">            r12 = var_48;</span><br><span class="line">            rdx-&gt;_originalObservable = r12;</span><br><span class="line">            var_38 = [rdi member:rdx];</span><br><span class="line">            rax = *__NSKeyValueObservationInfoCreateByAdding.shareableObservanceKey;</span><br><span class="line">            rax-&gt;_originalObservable = <span class="number">0x0</span>;</span><br><span class="line">            rax-&gt;_observer = <span class="number">0x0</span>;</span><br><span class="line">            rbx = var_38;</span><br><span class="line">            <span class="keyword">if</span> (rbx != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    [rbx retain];</span><br><span class="line">                    r14 = var_30;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 没有找到, 则创建observance</span></span><br><span class="line">                    rax = [NSKeyValueObservance alloc];</span><br><span class="line">                    rax = [rax _initWithObserver:r15 property:var_40 options:r14 context:r13 originalObservable:r12];</span><br><span class="line">                    rbx = rax;</span><br><span class="line">                    var_38 = rax;</span><br><span class="line">                    r14 = var_30;</span><br><span class="line">                    <span class="comment">// 可以缓存, 放入NSKeyValueShareableObservances中</span></span><br><span class="line">                    <span class="keyword">if</span> (rbx-&gt;_cachedIsShareable &lt; <span class="number">0x0</span>) &#123;</span><br><span class="line">                            [*_NSKeyValueShareableObservances addObject:rbx];</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r15 = arg6;</span><br><span class="line">            如果baseObservationInfo存在</span><br><span class="line">            <span class="keyword">if</span> (r14 != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 复制baseObservationInfo并追加observance</span></span><br><span class="line">                    r12 = [r14 _copyByAddingObservance:rbx];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 创建新的ObservationInfo</span></span><br><span class="line">                    r12 = [[NSKeyValueObservationInfo alloc] _initWithObservances:var_38 count:<span class="number">0x1</span> hashValue:<span class="number">0x0</span>];</span><br><span class="line">                    rbx = *var_38;</span><br><span class="line">            &#125;</span><br><span class="line">            [rbx release];</span><br><span class="line">            rbx = arg7;</span><br><span class="line">            <span class="comment">// 允许缓存, 添加到NSKeyValueShareableObservationInfos中</span></span><br><span class="line">            <span class="keyword">if</span> (r12-&gt;_cachedIsShareable != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    [*_NSKeyValueShareableObservationInfos addObject:r12];</span><br><span class="line">            &#125;</span><br><span class="line">            *(int8_t *)r15 = <span class="number">0x0</span>;</span><br><span class="line">            *rbx = var_38;</span><br><span class="line">    &#125;</span><br><span class="line">    os_unfair_lock_unlock(_NSKeyValueObservationInfoCreationLock);</span><br><span class="line">    rax = r12;</span><br><span class="line">    <span class="keyword">return</span> rax;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以发现上面针对<code>observationInfo</code>都是以弱引用的方式存贮的，那么真正是谁来管理<code>observationInfo</code>的生命周期呢</p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>我们可从这几个方面找到答案  </p>
<ul>
<li><code>ObservationInfo</code> 的setter getter方法</li>
<li>设置breakpoint 在dealloc 方法<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">void</span> -[NSObject setObservationInfo:](<span class="keyword">void</span> * self, <span class="keyword">void</span> * _cmd, <span class="keyword">void</span> * arg2) &#123;</span><br><span class="line">    r14 = arg2;</span><br><span class="line">    rbx = self;</span><br><span class="line">    <span class="comment">//主角登场，全局管理ObservationInfo的CFDictionary</span></span><br><span class="line">    rdi = *_NSKeyValueObservationInfoPerObject;</span><br><span class="line">    <span class="keyword">if</span> (rdi == <span class="number">0x0</span>) &#123;</span><br><span class="line">            rax = CFDictionaryCreateMutable(<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>);</span><br><span class="line">            rdi = rax;</span><br><span class="line">            *_NSKeyValueObservationInfoPerObject = rax;</span><br><span class="line">    &#125;</span><br><span class="line">    rsi = !rbx;</span><br><span class="line">    <span class="keyword">if</span> (r14 != <span class="number">0x0</span>) &#123;</span><br><span class="line">            rdx = r14;</span><br><span class="line">            CFDictionarySetValue(rdi, rsi, rdx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            CFDictionaryRemoveValue(rdi, rsi);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>__NSKeyValueRemoveObservationInfoForObject 在这个方法里面我们也能看到 <code>_NSKeyValueObservationInfoPerObject</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _NSKVODeallocate(int arg0, int arg1) &#123;</span><br><span class="line">    r12 = arg1;</span><br><span class="line">    r15 = arg0;</span><br><span class="line">    <span class="keyword">if</span> (*_NSKVODeallocate.onceToken != <span class="number">0xffffffffffffffff</span>) &#123;</span><br><span class="line">            dispatch_once(_NSKVODeallocate.onceToken, ^ &#123; <span class="comment">/* block implemented at ___NSKVODeallocate_block_invoke */</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    rax = object_getClass(r15);</span><br><span class="line">    rbx = rax;</span><br><span class="line">    <span class="keyword">if</span> (class_getMethodImplementation(rax, @selector(observationInfo)) != *_NSKVODeallocate.NSObjectObservationInfoImp) &#123;</span><br><span class="line">            r14 = <span class="number">0x0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            r14 = class_getMethodImplementation(rbx, @selector(setObservationInfo:)) == *_NSKVODeallocate.NSObjectSetObservationInfoImp ? <span class="number">0x1</span> : <span class="number">0x0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取object对应的observationInfo</span></span><br><span class="line">    r13 = __NSKeyValueRetainedObservationInfoForObject(r15, <span class="number">0x0</span>);</span><br><span class="line">    <span class="comment">// 获取notifyInfo</span></span><br><span class="line">    rax = object_getIndexedIvars(rbx);</span><br><span class="line">    var_38 = rax;</span><br><span class="line">    <span class="comment">// 调用object原来的dealloc实现</span></span><br><span class="line">    rbx = class_getInstanceMethod(*rax, r12);</span><br><span class="line">    <span class="keyword">if</span> (r14 != <span class="number">0x0</span>) &#123;</span><br><span class="line">            <span class="comment">// observationInfo不存在才对, 如果还存在, 说明没有正确地移除observer</span></span><br><span class="line">            method_invoke(r15, <span class="number">0x0</span>);</span><br><span class="line">            <span class="keyword">if</span> (r13 != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    __NSKeyValueRemoveObservationInfoForObject(r15);</span><br><span class="line">                    [r13 release];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x0</span> != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    objc_exception_rethrow();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">            *var_50 = r15;</span><br><span class="line">            *(var_50 + <span class="number">0x8</span>) = r13;</span><br><span class="line">            *(var_50 + <span class="number">0x10</span>) = <span class="number">0x0</span>;</span><br><span class="line">            <span class="comment">// 移除watcher</span></span><br><span class="line">            __NSKeyValueAddObservationInfoWatcher(var_50);</span><br><span class="line">            method_invoke(r15, rbx);</span><br><span class="line">            <span class="keyword">if</span> (var_48 != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    r14 = dyld_get_program_sdk_version();</span><br><span class="line">                    *(int8_t *)var_29 = <span class="number">0x0</span>;</span><br><span class="line">                    rbx = (var_29 == <span class="number">0x0</span> ? <span class="number">0x1</span> : <span class="number">0x0</span>) | (CFPreferencesGetAppBooleanValue(@<span class="string">"NSKVODeallocateCleansUpBeforeThrowing"</span>, *_kCFPreferencesCurrentApplication, var_29) == <span class="number">0x0</span> ? <span class="number">0x1</span> : <span class="number">0x0</span>);</span><br><span class="line">                    <span class="keyword">if</span> ((r14 &lt;= <span class="number">0x7ffff</span>) &amp;&amp; (rbx != <span class="number">0x0</span>)) &#123;</span><br><span class="line">                            _NSLog(@<span class="string">"An instance %p of class %@ was deallocated while key value observers were still registered with it. Observation info was leaked, and may even become mistakenly attached to some other object. Set a breakpoint on NSKVODeallocateBreak to stop here in the debu…"</span>, r15, *var_38);</span><br><span class="line">                            _NSKVODeallocateBreak(r15);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                            r14 = [var_48 description];</span><br><span class="line">                            <span class="keyword">if</span> (rbx == <span class="number">0x0</span>) &#123;</span><br><span class="line">                                    __NSKeyValueRemoveObservationInfoForObject(var_50);</span><br><span class="line">                            &#125;</span><br><span class="line">                            rdx = *_NSInternalInconsistencyException;</span><br><span class="line">                            [NSException raise:rdx format:@<span class="string">"An instance %p of class %@ was deallocated while key value observers were still registered with it. Current observation info: %@"</span>];</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            __NSKeyValueRemoveObservationInfoWatcher(var_50);</span><br><span class="line">            [var_48 release];</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0x0</span> != <span class="number">0x0</span>) &#123;</span><br><span class="line">                    objc_exception_rethrow();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="KVO源码中添加观察者时整体的大致流程是什么"><a href="#KVO源码中添加观察者时整体的大致流程是什么" class="headerlink" title="KVO源码中添加观察者时整体的大致流程是什么?"></a>KVO源码中添加观察者时整体的大致流程是什么?</h4><ol>
<li>将keyPath、class等信息封装成NSKeyValueProperty，分别解析一般属性(@”aa”)、可计算属性(@”@aa”)、属性链(@”<a href="mailto:aa.bb.@cc.dd" target="_blank" rel="noopener">aa.bb.@cc.dd</a>“)，进行子类化，缓存在CFMutableSet中方便下次快速取出。</li>
<li>将NSKeyValueProperty、context、options、observer等信息封装成NSKeyValueObservance，缓存在NSHashTable中。</li>
<li>倘若设置了NSKeyValueObservingOptionInitial选项，会在注册观察服务时调用一次触发方法。</li>
<li>动态创建名为NSKVONotifying_+原来类名的新类，重写其dealloc、_isKVOA方法，再重写class方法，利用object_setClass()函数将其isa指针指向原先的类。</li>
<li>重写willChangeValueForKey:和didChangeValueForKey:方法，重写被观察属性的setter方法，在setter中先调用willChangeValueForKey:方法，然后调用父类的 setter 方法对成员变量赋值，之后再调用 didChangeValueForKey: 方法。</li>
<li>didChangeValueForKey: 方法中会调用observeValueForKeyPath:ofObject:change:context:方法。</li>
</ol>
<h4 id="KVO中所封装组件的关系是怎样的"><a href="#KVO中所封装组件的关系是怎样的" class="headerlink" title="KVO中所封装组件的关系是怎样的?"></a>KVO中所封装组件的关系是怎样的?</h4><ol>
<li>将keyPath、class等信息封装成NSKeyValueProperty，使用CFMutableSet缓存NSKeyValueProperty。</li>
<li>将observer、property、options、context 、originalObservable等信息封装成NSKeyValueObservance，使用NSHashTable(NSKeyValueShareableObservationInfos)缓存。</li>
<li>NSKeyValueObservationInfo与NSKeyValueObservance的关系是: NSKeyValueObservationInfo中有一个observances数组，数组里面是NSKeyValueObservance对象。</li>
<li>每一个object都有一个observationInfo属性(void *类型)，它与NSKeyValueObservationInfo会相互转化。并交由_NSKeyValueObservationInfoPerObject全局管理</li>
</ol>
<p>附上动态库的本地路径<br>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks/</p>
<p>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/08/08/NSMethodSignature/" rel="next" title="NSMethodSignature">
                <i class="fa fa-chevron-left"></i> NSMethodSignature
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/07/重拾runtime/" rel="prev" title="重拾runtime">
                重拾runtime <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/profile/avatar.png" alt="yfeii">
            
              <p class="site-author-name" itemprop="name">yfeii</p>
              <div class="site-description motion-element" itemprop="description">邮箱1486662452@qq.com，有问题欢迎留言评论或邮件</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Foundation-framework"><span class="nav-number">1.</span> <span class="nav-text">Foundation.framework</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSKeyValueProperty"><span class="nav-number">1.1.</span> <span class="nav-text">NSKeyValueProperty</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取NSKeyValueProperty对象"><span class="nav-number">1.1.1.</span> <span class="nav-text">获取NSKeyValueProperty对象</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSKeyValueContainerClass"><span class="nav-number">1.2.</span> <span class="nav-text">NSKeyValueContainerClass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取NSKeyValueContainerClass"><span class="nav-number">1.2.1.</span> <span class="nav-text">获取NSKeyValueContainerClass</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#addObserver真正的实现"><span class="nav-number">1.3.</span> <span class="nav-text">_addObserver真正的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSKeyValueObserverInfo"><span class="nav-number">1.3.1.</span> <span class="nav-text">NSKeyValueObserverInfo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生命周期"><span class="nav-number">1.4.</span> <span class="nav-text">生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">1.5.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KVO源码中添加观察者时整体的大致流程是什么"><span class="nav-number">1.5.1.</span> <span class="nav-text">KVO源码中添加观察者时整体的大致流程是什么?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KVO中所封装组件的关系是怎样的"><span class="nav-number">1.5.2.</span> <span class="nav-text">KVO中所封装组件的关系是怎样的?</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yfeii</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>



  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "http://yfeii.github.io/2019/08/08/KVO/";
    this.page.identifier = "2019/08/08/KVO/";
    this.page.title = 'KVO';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    $(function() {
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll.disqus_scroll', function() {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('.disqus_scroll');
            loadComments();
          }
        });
      }
    });
  
</script>





  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
