<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="当我们按下 command+B之后发生了什么？App启动之前又做了什么？进程是如何创建的？主线程又是从哪里来的？ASLR如何生成的？">
<meta name="keywords" content="xcode">
<meta property="og:type" content="article">
<meta property="og:title" content="从编译到启动">
<meta property="og:url" content="http://yfeii.github.io/2020/04/21/编译启动系列文章之xcode-build/index.html">
<meta property="og:site_name" content="逆水行舟">
<meta property="og:description" content="当我们按下 command+B之后发生了什么？App启动之前又做了什么？进程是如何创建的？主线程又是从哪里来的？ASLR如何生成的？">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/FE8CF82B-A566-4BF6-A843-B06B2F901769.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/FFF8DF36-287D-4E62-920F-7A22D61E2B47.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/CC6A406D-0BB6-4F2E-86E4-569B4C120855.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/D1E810E6-6293-455E-8AC9-C94FA1EF603F.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/B4FB53EB-195C-469C-9775-BB2989C80735.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/68B8D8FE-9C31-4CC8-9EA7-E88162E61B2E.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/B816EA52-068D-4D99-B400-0BE9C6BE5FC3.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/52F6D38E-9952-4207-B3EF-134E0B118B82.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/7A16B0E1-559C-49A7-8CD2-05C5C434BB99.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/0E4ABBB3-9394-4C72-84C2-42D26FE7C3A8.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/3D502728-6436-4165-AC97-4EA27D56416C.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/38B2F659-0100-476B-9B21-13A304E19FB1.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/38B2F659-0100-476B-9B21-13A304E19FB1.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/905C88DA-D204-4244-8BD5-CF7C75002F75.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/82F4635F-0873-44FE-B502-36388BF8F697.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/1AE24545-8021-4C91-85CA-B3DA2F3EC14D.png">
<meta property="og:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/0F0459C5-134F-44BA-845D-57087593EDA8.png">
<meta property="og:updated_time" content="2020-05-06T02:45:24.205Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从编译到启动">
<meta name="twitter:description" content="当我们按下 command+B之后发生了什么？App启动之前又做了什么？进程是如何创建的？主线程又是从哪里来的？ASLR如何生成的？">
<meta name="twitter:image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/FE8CF82B-A566-4BF6-A843-B06B2F901769.png">





  
  
  <link rel="canonical" href="http://yfeii.github.io/2020/04/21/编译启动系列文章之xcode-build/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>从编译到启动 | 逆水行舟</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">逆水行舟</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yfeii.github.io/2020/04/21/编译启动系列文章之xcode-build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yfeii">
      <meta itemprop="description" content="邮箱1486662452@qq.com，有问题欢迎留言评论或邮件">
      <meta itemprop="image" content="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/profile/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="逆水行舟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从编译到启动

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-04-21 12:31:18" itemprop="dateCreated datePublished" datetime="2020-04-21T12:31:18+08:00">2020-04-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-05-06 10:45:24" itemprop="dateModified" datetime="2020-05-06T10:45:24+08:00">2020-05-06</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编译及操作系统/" itemprop="url" rel="index"><span itemprop="name">编译及操作系统</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>当我们按下 <code>command+B</code>之后发生了什么？App启动之前又做了什么？进程是如何创建的？主线程又是从哪里来的？ASLR如何生成的？<a id="more"></a></p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>本文的重点不在于“编译的细节（预处理，词法分析等等）”，而在于除了这些之外：xcode还做了什么。以及App启动之前，或者说dyld之前又做了什么。  </p>
<p>下面开始第一部分：编译。</p>
<h2 id="xcode-build"><a href="#xcode-build" class="headerlink" title="xcode build"></a>xcode build</h2><p> <code>xcode</code>的构建主要是下面任务的集合：</p>
<ul>
<li>源码的编译，链接。  </li>
<li>资源(asset,storyBoard,headers)的拷贝和处理</li>
<li><p>代码签名校验和一些自定义的脚本。</p>
<p>同时这些任务是按照特定 的顺序来执行的：依赖关系。</p>
<p>我们可倒推一下这个依赖关系，如下(图片来源WWDC)：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/FE8CF82B-A566-4BF6-A843-B06B2F901769.png" alt="img"></p>
</li>
</ul>
<p>在构建的第一步就会解析项目的配置，构建依赖关系，这一步会形成一个“定向图”<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/FFF8DF36-287D-4E62-920F-7A22D61E2B47.png" alt="img"></p>
<h2 id="依赖的组成-来源"><a href="#依赖的组成-来源" class="headerlink" title="依赖的组成(来源)"></a>依赖的组成(来源)</h2><p>依赖的来源主要有一下几个部分：</p>
<ul>
<li>xcode 内置的编译规则，比如：编译器，链接器，还有一些资源目录，这些规则决定了哪些是输入文件，哪些是输出。  </li>
<li>显式声明的依赖关系：Target Dependencies</li>
<li>隐式声明的依赖关系：Linked Frameworks and Libraries  </li>
<li>Build Phase</li>
</ul>
<h2 id="构建优化"><a href="#构建优化" class="headerlink" title="构建优化"></a>构建优化</h2><h3 id="增量编译"><a href="#增量编译" class="headerlink" title="增量编译"></a>增量编译</h3><p>通过上面的“定向图”，我们知道一次编辑，会执行上面的所有内容，为了提高编译速度，减少无效的任务，xcode使用了增量编译技术。</p>
<p>在每一个构建任务中，都会生成相应的签名，这个“签名”任务的输入路径、修改时间、编译器版本信息、有关任务的元数据等组成。<br>在构建之前会检查签名是否和当前一直，来决定是否跳过当前任务。</p>
<h3 id="并行编译"><a href="#并行编译" class="headerlink" title="并行编译"></a>并行编译</h3><p>在scheme的设置中，可以选择是否开启并行编译（默认开启）。</p>
<p>经测试，在有缓存的情况下如下:<br>开启并行：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/CC6A406D-0BB6-4F2E-86E4-569B4C120855.png" alt="img"><br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/D1E810E6-6293-455E-8AC9-C94FA1EF603F.png" alt="img"></p>
<p>关闭：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/B4FB53EB-195C-469C-9775-BB2989C80735.png" alt="img"><br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/68B8D8FE-9C31-4CC8-9EA7-E88162E61B2E.png" alt="img"><br>clean之后<br>开启并行：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/B816EA52-068D-4D99-B400-0BE9C6BE5FC3.png" alt="img"></p>
<p>关闭：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/52F6D38E-9952-4207-B3EF-134E0B118B82.png" alt="img"></p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>这是作者的一个真实项目，我们先来看一下构建流程<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/7A16B0E1-559C-49A7-8CD2-05C5C434BB99.png" alt="img"><br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/0E4ABBB3-9394-4C72-84C2-42D26FE7C3A8.png" alt="img"><br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/3D502728-6436-4165-AC97-4EA27D56416C.png" alt="img"></p>
<h3 id="xcode-构建日志"><a href="#xcode-构建日志" class="headerlink" title="xcode 构建日志"></a>xcode 构建日志</h3><p>先来大致梳理一下构建过程：</p>
<ul>
<li>创建app包文件。  </li>
<li>创建库目录。</li>
<li>文件写入。包括：Entitlements.plist，xxx.hmap。</li>
<li>执行CocoaPods的编译前脚本：检查Manifest.lock文件。</li>
<li>写入对应的，编译.m文件，生成.o文件。</li>
<li>编译assets，编译storyboard，链接storyboard。  </li>
<li>写入debug信息。  </li>
<li>执行CocoaPods编译后脚本：拷贝CocoaPods Target生成的Framework。  </li>
<li>拷贝swift标准库。  </li>
<li>签名并验证app。  </li>
</ul>
<p>下面我们来特别说明在wwdc中提到的，其中的一些步骤。<br>构建的第一个步骤是创建app文件。这个步骤只有在第一次构建的时候才会有创建，在后续的增量编译中，不会再重复创建。</p>
<h3 id="headermap"><a href="#headermap" class="headerlink" title="headermap"></a>headermap</h3><p>先来看一下<code>headermap</code>内容。<a href="https://github.com/milend/hmap" target="_blank" rel="noopener">这里</a>有个查看<code>hmap</code>的工具。<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/38B2F659-0100-476B-9B21-13A304E19FB1.png" alt="img"><br>我们可以看到<code>headermap</code>其实就是编译器找到头文件的辅助文件：存储这头文件到其物理路径的映射关系。<br>再来看一下编译器是如何使用的。我们从构建日志中复制一个<code>Compile</code>的完整命令，再后面加上<code>-v</code>。<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/38B2F659-0100-476B-9B21-13A304E19FB1.png" alt="img"></p>
<h3 id="linkfilelist"><a href="#linkfilelist" class="headerlink" title="linkfilelist"></a>linkfilelist</h3><p>这个文件包含了所有需要被链接的目标文件(.o)，和<code>Link Map File</code>不同，前者是链接时就需要的辅助文件，后者是链接之后的产物。来看一个具体的文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/NIMSessionMessageContentView.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/SQTUserCommerceInfoModel.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/SQTAlipayAuthInfoAPI.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/SQTCommercaListVC.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/CTMediator+MemberList.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/SQTTopicSupportAPI.o</span><br><span class="line">n/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/NIMVideoContentConfig.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/CALayer+YYAdd.o</span><br><span class="line">/Users/xxx/Library/Developer/Xcode/DerivedData/sqt-ios-garxjzclbjremabwulpvhqmspmyr/Build/Intermediates.noindex/sqt-ios.build/Debug-iphoneos/sqt-ios.build/Objects-normal/arm64/SQTMemoryCache.o</span><br></pre></td></tr></table></figure></p>
<p>下面来看一下什么时候被使用：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/905C88DA-D204-4244-8BD5-CF7C75002F75.png" alt="img"><br>由于命令过长（demo为真实项目），这不在展开。</p>
<p>下面进入第二部分：App启动。</p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h3 id="进程的创建"><a href="#进程的创建" class="headerlink" title="进程的创建"></a>进程的创建</h3><p>在UNIX模型中(也是OSX)模型，是不支持“空进程”或“新进程”的，同时进程不能被创建出来的，只能通过<code>fork</code>系统调用复制出来。如下图所示：<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/82F4635F-0873-44FE-B502-36388BF8F697.png" alt="img"><br>最终创建的流程会被汇总到<code>fork1</code>中，这里需要主要<code>vfork</code>流程并不会创建真正的<code>mach</code>层面的进程。而是由后面<code>execve</code>函数来进行真正的创建，这个在二进制加载章节会讲。<br><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/1AE24545-8021-4C91-85CA-B3DA2F3EC14D.png" alt="img"></p>
<h3 id="二进制文件的加载"><a href="#二进制文件的加载" class="headerlink" title="二进制文件的加载"></a>二进制文件的加载</h3><p>经由上面流程“创建”出来的进程没有实质上的作用，除非执行了另外一个可执行程序。因此，进程创建的核心在于二进制文件的加载和执行。</p>
<h4 id="mac-execve"><a href="#mac-execve" class="headerlink" title="__\mac_execve"></a>__\mac_execve</h4><p>进程创建的核心在于二进制文件的加载和执行，下面我们来查看一下加载过程<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nt</span><br><span class="line">__mac_execve(proc_t p, struct __mac_execve_args *uap, int32_t *retval)</span><br><span class="line">&#123;</span><br><span class="line">    char *bufp = NULL;</span><br><span class="line">    struct image_params *imgp;</span><br><span class="line">    struct vnode_attr *vap;</span><br><span class="line">    struct vnode_attr *origvap;</span><br><span class="line">    int error;</span><br><span class="line">    int is_64 = IS_64BIT_PROCESS(p);</span><br><span class="line">    struct vfs_context context;</span><br><span class="line">    struct uthread  *uthread;</span><br><span class="line">    task_t old_task = current_task();</span><br><span class="line">    task_t new_task = NULL;</span><br><span class="line">    boolean_t should_release_proc_ref = FALSE;</span><br><span class="line">    boolean_t exec_done = FALSE;</span><br><span class="line">    boolean_t in_vfexec = FALSE;</span><br><span class="line">    <span class="keyword">void</span> *inherit = NULL;</span><br><span class="line"></span><br><span class="line">    context.vc_thread = current_thread();</span><br><span class="line">    context.vc_ucred = kauth_cred_proc_ref(p);      <span class="comment">/* XXX must NOT be kauth_cred_get() */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate a big chunk for locals instead of using stack since these</span></span><br><span class="line"><span class="comment">     * structures a pretty big.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="comment">//申请内存</span></span><br><span class="line">    MALLOC(bufp, char *, (sizeof(*imgp) + sizeof(*vap) + sizeof(*origvap)), M_TEMP, M_WAITOK | M_ZERO);</span><br><span class="line">    imgp = (struct image_params *) bufp;</span><br><span class="line">    <span class="keyword">if</span> (bufp == NULL) &#123;</span><br><span class="line">        error = ENOMEM;</span><br><span class="line">        goto exit_with_error;</span><br><span class="line">    &#125;</span><br><span class="line">    vap = (struct vnode_attr *) (bufp + sizeof(*imgp));</span><br><span class="line">    origvap = (struct vnode_attr *) (bufp + sizeof(*imgp) + sizeof(*vap));</span><br><span class="line">    <span class="comment">//初始化ip 结构</span></span><br><span class="line">    <span class="comment">/* Initialize the common data in the image_params structure */</span></span><br><span class="line">    imgp-&gt;ip_user_fname = uap-&gt;fname;</span><br><span class="line">    imgp-&gt;ip_user_argv = uap-&gt;argp;</span><br><span class="line">    imgp-&gt;ip_user_envv = uap-&gt;envp;</span><br><span class="line">    imgp-&gt;ip_vattr = vap;</span><br><span class="line">    imgp-&gt;ip_origvattr = origvap;</span><br><span class="line">    imgp-&gt;ip_vfs_context = &amp;context;</span><br><span class="line">    imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT_ADDR : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</span><br><span class="line">    imgp-&gt;ip_seg = (is_64 ? UIO_USERSPACE64 : UIO_USERSPACE32);</span><br><span class="line">    imgp-&gt;ip_mac_return = <span class="number">0</span>;</span><br><span class="line">    imgp-&gt;ip_cs_error = OS_REASON_NULL;</span><br><span class="line">    imgp-&gt;ip_simulator_binary = IMGPF_SB_DEFAULT;</span><br><span class="line"></span><br><span class="line">#if CONFIG_MACF</span><br><span class="line">    <span class="keyword">if</span> (uap-&gt;mac_p != USER_ADDR_NULL) &#123;</span><br><span class="line">        error = mac_execve_enter(uap-&gt;mac_p, imgp);</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            kauth_cred_unref(&amp;context.vc_ucred);</span><br><span class="line">            goto exit_with_error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    <span class="comment">//获取mach对应的bsd线程。thread_t-&gt;uthread_t</span></span><br><span class="line">    uthread = get_bsdthread_info(current_thread());</span><br><span class="line">    <span class="keyword">if</span> (uthread-&gt;uu_flag &amp; UT_VFORK) &#123;</span><br><span class="line">        imgp-&gt;ip_flags |= IMGPF_VFORK_EXEC;</span><br><span class="line">        in_vfexec = TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        imgp-&gt;ip_flags |= IMGPF_EXEC;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * For execve case, create a new task and thread</span></span><br><span class="line"><span class="comment">         * which points to current_proc. The current_proc will point</span></span><br><span class="line"><span class="comment">         * to the new task after image activation and proc ref drain.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * proc (current_proc) &lt;-----  old_task (current_task)</span></span><br><span class="line"><span class="comment">         *  ^ |                                ^</span></span><br><span class="line"><span class="comment">         *  | |                                |</span></span><br><span class="line"><span class="comment">         *  | ----------------------------------</span></span><br><span class="line"><span class="comment">         *  |</span></span><br><span class="line"><span class="comment">         *  --------- new_task (task marked as TF_EXEC_COPY)</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * After image activation, the proc will point to the new task</span></span><br><span class="line"><span class="comment">         * and would look like following.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * proc (current_proc)  &lt;-----  old_task (current_task, marked as TPF_DID_EXEC)</span></span><br><span class="line"><span class="comment">         *  ^ |</span></span><br><span class="line"><span class="comment">         *  | |</span></span><br><span class="line"><span class="comment">         *  | ----------&gt; new_task</span></span><br><span class="line"><span class="comment">         *  |               |</span></span><br><span class="line"><span class="comment">         *  -----------------</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * During exec any transition from new_task -&gt; proc is fine, but don't allow</span></span><br><span class="line"><span class="comment">         * transition from proc-&gt;task, since it will modify old_task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        imgp-&gt;ip_new_thread = fork_create_child(old_task,</span><br><span class="line">            NULL,</span><br><span class="line">            p,</span><br><span class="line">            FALSE,</span><br><span class="line">            p-&gt;p_flag &amp; P_LP64,</span><br><span class="line">            task_get_64bit_data(old_task),</span><br><span class="line">            TRUE);</span><br><span class="line">        <span class="comment">/* task and thread ref returned by fork_create_child */</span></span><br><span class="line">        <span class="keyword">if</span> (imgp-&gt;ip_new_thread == NULL) &#123;</span><br><span class="line">            error = ENOMEM;</span><br><span class="line">            goto exit_with_error;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        new_task = get_threadtask(imgp-&gt;ip_new_thread);</span><br><span class="line">        context.vc_thread = imgp-&gt;ip_new_thread;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//处理二进制的主要逻辑</span></span><br><span class="line">    error = exec_activate_image(imgp);</span><br><span class="line">    <span class="comment">/* thread and task ref returned for vfexec case */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_new_thread != NULL) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * task reference might be returned by exec_activate_image</span></span><br><span class="line"><span class="comment">         * for vfexec.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        new_task = get_threadtask(imgp-&gt;ip_new_thread);</span><br><span class="line">#if defined(HAS_APPLE_PAC)</span><br><span class="line">        ml_task_set_disable_user_jop(new_task, imgp-&gt;ip_flags &amp; IMGPF_NOJOP ? TRUE : FALSE);</span><br><span class="line">        ml_thread_set_disable_user_jop(imgp-&gt;ip_new_thread, imgp-&gt;ip_flags &amp; IMGPF_NOJOP ? TRUE : FALSE);</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error &amp;&amp; !in_vfexec) &#123;</span><br><span class="line">        p = proc_exec_switch_task(p, old_task, new_task, imgp-&gt;ip_new_thread);</span><br><span class="line">        <span class="comment">/* proc ref returned */</span></span><br><span class="line">        should_release_proc_ref = TRUE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Need to transfer pending watch port boosts to the new task while still making</span></span><br><span class="line"><span class="comment">         * sure that the old task remains in the importance linkage. Create an importance</span></span><br><span class="line"><span class="comment">         * linkage from old task to new task, then switch the task importance base</span></span><br><span class="line"><span class="comment">         * of old task and new task. After the switch the port watch boost will be</span></span><br><span class="line"><span class="comment">         * boosting the new task and new task will be donating importance to old task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        inherit = ipc_importance_exec_switch_task(old_task, new_task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kauth_cred_unref(&amp;context.vc_ucred);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Image not claimed by any activator? */</span></span><br><span class="line">    <span class="keyword">if</span> (error == <span class="number">-1</span>) &#123;</span><br><span class="line">        error = ENOEXEC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">        exec_done = TRUE;</span><br><span class="line">        assert(imgp-&gt;ip_new_thread != NULL);</span><br><span class="line"></span><br><span class="line">        exec_resettextvp(p, imgp);</span><br><span class="line">        error = check_for_signature(p, imgp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* flag exec has occurred, notify only if it has not failed due to FP Key error */</span></span><br><span class="line">    <span class="keyword">if</span> (exec_done &amp;&amp; ((p-&gt;p_lflag &amp; P_LTERM_DECRYPTFAIL) == <span class="number">0</span>)) &#123;</span><br><span class="line">        proc_knote(p, NOTE_EXEC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_vp != NULLVP) &#123;</span><br><span class="line">        vnode_put(imgp-&gt;ip_vp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_scriptvp != NULLVP) &#123;</span><br><span class="line">        vnode_put(imgp-&gt;ip_scriptvp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_strings) &#123;</span><br><span class="line">        execargs_free(imgp);</span><br><span class="line">    &#125;</span><br><span class="line">#if CONFIG_MACF</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_execlabelp) &#123;</span><br><span class="line">        mac_cred_label_free(imgp-&gt;ip_execlabelp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp) &#123;</span><br><span class="line">        mac_vnode_label_free(imgp-&gt;ip_scriptlabelp);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_cs_error != OS_REASON_NULL) &#123;</span><br><span class="line">        os_reason_free(imgp-&gt;ip_cs_error);</span><br><span class="line">        imgp-&gt;ip_cs_error = OS_REASON_NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * We need to initialize the bank context behind the protection of</span></span><br><span class="line"><span class="comment">         * the proc_trans lock to prevent a race with exit. We can't do this during</span></span><br><span class="line"><span class="comment">         * exec_activate_image because task_bank_init checks entitlements that</span></span><br><span class="line"><span class="comment">         * aren't loaded until subsequent calls (including exec_resettextvp).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        error = proc_transstart(p, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">        task_bank_init(new_task);</span><br><span class="line">        proc_transend(p, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">#if __arm64__</span><br><span class="line">        proc_legacy_footprint_entitled(p, new_task, __FUNCTION__);</span><br><span class="line">#endif /* __arm64__ */</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Sever any extant thread affinity */</span></span><br><span class="line">        thread_affinity_exec(current_thread());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Inherit task role from old task to new task for exec */</span></span><br><span class="line">        <span class="keyword">if</span> (!in_vfexec) &#123;</span><br><span class="line">            proc_inherit_task_role(new_task, old_task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        thread_t main_thread = imgp-&gt;ip_new_thread;</span><br><span class="line"></span><br><span class="line">        task_set_main_thread_qos(new_task, main_thread);</span><br><span class="line"></span><br><span class="line">#if CONFIG_ARCADE</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Check to see if we need to trigger an arcade upcall AST now</span></span><br><span class="line"><span class="comment">         * that the vnode has been reset on the task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        arcade_prepare(new_task, imgp-&gt;ip_new_thread);</span><br><span class="line">#endif /* CONFIG_ARCADE */</span><br><span class="line"></span><br><span class="line">#if CONFIG_MACF</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Processes with the MAP_JIT entitlement are permitted to have</span></span><br><span class="line"><span class="comment">         * a jumbo-size map.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (mac_proc_check_map_anon(p, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, MAP_JIT, NULL) == <span class="number">0</span>) &#123;</span><br><span class="line">            vm_map_set_jumbo(get_task_map(new_task));</span><br><span class="line">            vm_map_set_jit_entitled(get_task_map(new_task));</span><br><span class="line">        &#125;</span><br><span class="line">#endif /* CONFIG_MACF */</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vm_darkwake_mode == TRUE) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * This process is being launched when the system</span></span><br><span class="line"><span class="comment">             * is in darkwake. So mark it specially. This will</span></span><br><span class="line"><span class="comment">             * cause all its pages to be entered in the background Q.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            task_set_darkwake_mode(new_task, vm_darkwake_mode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if CONFIG_DTRACE</span><br><span class="line">        dtrace_thread_didexec(imgp-&gt;ip_new_thread);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((dtrace_proc_waitfor_hook = dtrace_proc_waitfor_exec_ptr) != NULL) &#123;</span><br><span class="line">            (*dtrace_proc_waitfor_hook)(p);</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if CONFIG_AUDIT</span><br><span class="line">        <span class="keyword">if</span> (!error &amp;&amp; AUDIT_ENABLED() &amp;&amp; p) &#123;</span><br><span class="line">            <span class="comment">/* Add the CDHash of the new process to the audit record */</span></span><br><span class="line">            uint8_t *cdhash = cs_get_cdhash(p);</span><br><span class="line">            <span class="keyword">if</span> (cdhash) &#123;</span><br><span class="line">                AUDIT_ARG(data, cdhash, sizeof(uint8_t), CS_CDHASH_LEN);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_vfexec) &#123;</span><br><span class="line">            vfork_return(p, retval, p-&gt;p_pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DTRACE_PROC1(exec__failure, int, error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">exit_with_error:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * clear bsd_info from old task if it did exec.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (task_did_exec(old_task)) &#123;</span><br><span class="line">        set_bsdtask_info(old_task, NULL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* clear bsd_info from new task and terminate it if exec failed  */</span></span><br><span class="line">    <span class="keyword">if</span> (new_task != NULL &amp;&amp; task_is_exec_copy(new_task)) &#123;</span><br><span class="line">        set_bsdtask_info(new_task, NULL);</span><br><span class="line">        task_terminate_internal(new_task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (imgp != NULL) &#123;</span><br><span class="line">        <span class="comment">/* Clear the initial wait on the thread transferring watchports */</span></span><br><span class="line">        <span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</span><br><span class="line">            task_clear_return_wait(get_threadtask(imgp-&gt;ip_new_thread), TCRW_CLEAR_INITIAL_WAIT);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Transfer the watchport boost to new task */</span></span><br><span class="line">        <span class="keyword">if</span> (!error &amp;&amp; !in_vfexec) &#123;</span><br><span class="line">            task_transfer_turnstile_watchports(old_task,</span><br><span class="line">                new_task, imgp-&gt;ip_new_thread);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Do not terminate the current task, if proc_exec_switch_task did not</span></span><br><span class="line"><span class="comment">         * switch the tasks, terminating the current task without the switch would</span></span><br><span class="line"><span class="comment">         * result in loosing the SIGKILL status.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (task_did_exec(old_task)) &#123;</span><br><span class="line">            <span class="comment">/* Terminate the current task, since exec will start in new task */</span></span><br><span class="line">            task_terminate_internal(old_task);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Release the thread ref returned by fork_create_child */</span></span><br><span class="line">        <span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</span><br><span class="line">            <span class="comment">/* wake up the new exec thread */</span></span><br><span class="line">            task_clear_return_wait(get_threadtask(imgp-&gt;ip_new_thread), TCRW_CLEAR_FINAL_WAIT);</span><br><span class="line">            thread_deallocate(imgp-&gt;ip_new_thread);</span><br><span class="line">            imgp-&gt;ip_new_thread = NULL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Release the ref returned by fork_create_child */</span></span><br><span class="line">    <span class="keyword">if</span> (new_task) &#123;</span><br><span class="line">        task_deallocate(new_task);</span><br><span class="line">        new_task = NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (should_release_proc_ref) &#123;</span><br><span class="line">        proc_rele(p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bufp != NULL) &#123;</span><br><span class="line">        FREE(bufp, M_TEMP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inherit != NULL) &#123;</span><br><span class="line">        ipc_importance_release(inherit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中主要的逻辑是构造<code>image_params</code>。其定义如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">struct image_params &#123;</span><br><span class="line">    user_addr_t     ip_user_fname;          <span class="comment">/* argument 文件名*/</span></span><br><span class="line">    user_addr_t     ip_user_argv;           <span class="comment">/* argument 参数*/</span></span><br><span class="line">    user_addr_t     ip_user_envv;           <span class="comment">/* argument 环境参数*/</span></span><br><span class="line">    int             ip_seg;                 <span class="comment">/* segment for arguments 参数段*/</span></span><br><span class="line">    struct vnode    *ip_vp;                 <span class="comment">/* file 文件*/</span></span><br><span class="line">    struct vnode_attr       *ip_vattr;      <span class="comment">/* run file attributes，run文件属性*/</span></span><br><span class="line">    struct vnode_attr       *ip_origvattr;  <span class="comment">/* invocation file attributes，invocation文件属性*/</span></span><br><span class="line">    cpu_type_t      ip_origcputype;         <span class="comment">/* cputype of invocation file ，invocation文件的cpu类型*/</span></span><br><span class="line">    cpu_subtype_t   ip_origcpusubtype;      <span class="comment">/* subtype of invocation file ，invocation文件的cpu子类型*/</span></span><br><span class="line">    char            *ip_vdata;              <span class="comment">/* file data (up to one page)，文件数据（最多一页）*/</span></span><br><span class="line">    int             ip_flags;               <span class="comment">/* image flags，标志位*/</span></span><br><span class="line">    int             ip_argc;                <span class="comment">/* argument count，参数计数*/</span></span><br><span class="line">    int             ip_envc;                <span class="comment">/* environment count，环境变量计数*/</span></span><br><span class="line">    int             ip_applec;              <span class="comment">/* apple vector count，apple向量计数*/</span></span><br><span class="line"></span><br><span class="line">    char            *ip_startargv;          <span class="comment">/* argument vector beginning，参数向量开始*/</span></span><br><span class="line">    char            *ip_endargv;            <span class="comment">/* end of argv/start of envv，argv结束/envv开始*/</span></span><br><span class="line">    char            *ip_endenvv;            <span class="comment">/* end of envv/start of applev，envv结束/applev开始*/</span></span><br><span class="line"></span><br><span class="line">    char            *ip_strings;            <span class="comment">/* base address for strings，字符串的基址*/</span></span><br><span class="line">    char            *ip_strendp;            <span class="comment">/* current end pointer，当前end指针*/</span></span><br><span class="line"></span><br><span class="line">    int             ip_argspace;            <span class="comment">/* remaining space of NCARGS limit (argv+envv)，NCARGS限制(argv+envv)中剩下的空间*/</span></span><br><span class="line">    int             ip_strspace;            <span class="comment">/* remaining total string space，总字符串空间剩下的空间*/</span></span><br><span class="line"></span><br><span class="line">    user_size_t     ip_arch_offset;         <span class="comment">/* subfile offset in ip_vp，ip_vp中子文件的偏移*/</span></span><br><span class="line">    user_size_t     ip_arch_size;           <span class="comment">/* subfile length in ip_vp，ip_vp中子文件的长度*/</span></span><br><span class="line">    char            ip_interp_buffer[IMG_SHSIZE];   <span class="comment">/* interpreter buffer space，解释器缓冲区*/</span></span><br><span class="line">    int             ip_interp_sugid_fd;             <span class="comment">/* fd for sugid script，sugid脚本的fd*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Next two fields are for support of architecture translation... ，下面两个字段用于架构的翻译*/</span></span><br><span class="line">    struct vfs_context      *ip_vfs_context;        <span class="comment">/* VFS context vfs上下文 */</span></span><br><span class="line">    struct nameidata *ip_ndp;               <span class="comment">/* current nameidata 当前的nameidata*/</span></span><br><span class="line">    thread_t        ip_new_thread;          <span class="comment">/* thread for spawn/vfork，用于vfor/或者spawn的线程*/</span></span><br><span class="line"></span><br><span class="line">    struct label    *ip_execlabelp;         <span class="comment">/* label of the executable，可执行文件的标签*/</span></span><br><span class="line">    struct label    *ip_scriptlabelp;       <span class="comment">/* label of the script，脚本标签*/</span></span><br><span class="line">    struct vnode    *ip_scriptvp;           <span class="comment">/* script 脚本*/</span></span><br><span class="line">    unsigned int    ip_csflags;             <span class="comment">/* code signing flags 签名标志位*/</span></span><br><span class="line">    int             ip_mac_return;          <span class="comment">/* return code from mac policy checks */</span></span><br><span class="line">    <span class="keyword">void</span>            *ip_px_sa;</span><br><span class="line">    <span class="keyword">void</span>            *ip_px_sfa;</span><br><span class="line">    <span class="keyword">void</span>            *ip_px_spa;</span><br><span class="line">    <span class="keyword">void</span>            *ip_px_smpx;            <span class="comment">/* MAC-specific spawn attrs. */</span></span><br><span class="line">    <span class="keyword">void</span>            *ip_px_persona;         <span class="comment">/* persona args */</span></span><br><span class="line">    <span class="keyword">void</span>            *ip_px_pcred_info;      <span class="comment">/* posix cred args */</span></span><br><span class="line">    <span class="keyword">void</span>            *ip_cs_error;           <span class="comment">/* codesigning error reason */</span></span><br><span class="line"></span><br><span class="line">    uint64_t ip_dyld_fsid;</span><br><span class="line">    uint64_t ip_dyld_fsobjid;</span><br><span class="line">    unsigned int    ip_simulator_binary;    <span class="comment">/* simulator binary flags */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>__\mac_execve</code>函数的主要流程如下：</p>
<ol>
<li>创建相关结构体指针。  </li>
<li>为imgp申请大块内存。  </li>
<li>设置线程信息：（vfork则直接设置标记，否则重新创建线程）。  </li>
<li>执行加载imgp。</li>
</ol>
<p>接下来是执行激活二进制</p>
<h4 id="exec-activate-image"><a href="#exec-activate-image" class="headerlink" title="exec_activate_image"></a>exec_activate_image</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> int</span><br><span class="line">exec_activate_image(struct image_params *imgp)</span><br><span class="line">&#123;</span><br><span class="line">    struct nameidata *ndp = NULL;<span class="comment">//https://linux.die.net/man/1/namei</span></span><br><span class="line">    <span class="keyword">const</span> char *excpath;</span><br><span class="line">    int error;</span><br><span class="line">    int resid;</span><br><span class="line">    int once = <span class="number">1</span>;   <span class="comment">/* save SGUID-ness for interpreted files */</span></span><br><span class="line">    int i;</span><br><span class="line">    int itercount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//从vfs向下文环境中获得 proc_t </span></span><br><span class="line">    proc_t p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分配内核内存用于保存用户空间的参数和镜像的第一个页面</span></span><br><span class="line">    error = execargs_alloc(imgp);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        goto bad_notrans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//保存程序路径并修正参数</span></span><br><span class="line">    error = exec_save_path(imgp, imgp-&gt;ip_user_fname, imgp-&gt;ip_seg, &amp;excpath);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        goto bad_notrans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Use excpath, which contains the copyin-ed exec path */</span></span><br><span class="line">    DTRACE_PROC1(exec, uintptr_t, excpath);</span><br><span class="line"></span><br><span class="line">    MALLOC(ndp, struct nameidata *, sizeof(*ndp), M_TEMP, M_WAITOK | M_ZERO);</span><br><span class="line">    <span class="keyword">if</span> (ndp == NULL) &#123;</span><br><span class="line">        error = ENOMEM;</span><br><span class="line">        goto bad_notrans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF | AUDITVNPATH1,</span><br><span class="line">        UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line">    <span class="comment">//通过 namei() 方法找二进制文件</span></span><br><span class="line">    error = namei(ndp);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        goto bad_notrans;</span><br><span class="line">    &#125;</span><br><span class="line">    imgp-&gt;ip_ndp = ndp;     <span class="comment">/* successful namei(); call nameidone() later */</span></span><br><span class="line">    imgp-&gt;ip_vp = ndp-&gt;ni_vp;       <span class="comment">/* if set, need to vnode_put() at some point */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Before we start the transition from binary A to binary B, make</span></span><br><span class="line"><span class="comment">     * sure another thread hasn't started exiting the process.  We grab</span></span><br><span class="line"><span class="comment">     * the proc lock to check p_lflag initially, and the transition</span></span><br><span class="line"><span class="comment">     * mechanism ensures that the value doesn't change after we release</span></span><br><span class="line"><span class="comment">     * the lock.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//确保进程中没有其他线程执行exit</span></span><br><span class="line">    proc_lock(p);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;p_lflag &amp; P_LEXIT) &#123;</span><br><span class="line">        error = EDEADLK;</span><br><span class="line">        proc_unlock(p);</span><br><span class="line">        goto bad_notrans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//标记转换开始</span></span><br><span class="line">    error = proc_transstart(p, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    proc_unlock(p);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        goto bad_notrans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//权限检查，</span></span><br><span class="line">    error = exec_check_permissions(imgp);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        goto bad;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy; avoid invocation of an interpreter overwriting the original */</span></span><br><span class="line">    <span class="keyword">if</span> (once) &#123;</span><br><span class="line">        once = <span class="number">0</span>;</span><br><span class="line">        *imgp-&gt;ip_origvattr = *imgp-&gt;ip_vattr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将第一个页面加载到内存中</span></span><br><span class="line">    error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</span><br><span class="line">        UIO_SYSSPACE, IO_NODELOCKED,</span><br><span class="line">        vfs_context_ucred(imgp-&gt;ip_vfs_context),</span><br><span class="line">        &amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        goto bad;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resid) &#123;</span><br><span class="line">        memset(imgp-&gt;ip_vdata + (PAGE_SIZE - resid), <span class="number">0x0</span>, resid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">encapsulated_binary:</span><br><span class="line">    <span class="comment">/* Limit the number of iterations we will attempt on each binary */</span></span><br><span class="line">    <span class="keyword">if</span> (++itercount &gt; EAI_ITERLIMIT) &#123;</span><br><span class="line">        error = EBADEXEC;</span><br><span class="line">        goto bad;</span><br><span class="line">    &#125;</span><br><span class="line">    error = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">//遍历execsw数组，调用ex_imgact函数确定 二进制类型</span></span><br><span class="line">    <span class="comment">// "Mach-o Binary" "Fat Binary" "Interpreter Script" </span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; error == <span class="number">-1</span> &amp;&amp; execsw[i].ex_imgact != NULL; i++) &#123;</span><br><span class="line">        error = (*execsw[i].ex_imgact)(imgp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (error) &#123;</span><br><span class="line">        <span class="comment">/* case -1: not claimed: continue */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">-2</span>:                <span class="comment">/* Encapsulated binary, imgp-&gt;ip_XXX set for next iteration */</span></span><br><span class="line">            goto encapsulated_binary;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">-3</span>:                <span class="comment">/* Interpreter */</span></span><br><span class="line">#if CONFIG_MACF</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Copy the script label for later use. Note that</span></span><br><span class="line"><span class="comment">             * the label can be different when the script is</span></span><br><span class="line"><span class="comment">             * actually read by the interpreter.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp) &#123;</span><br><span class="line">                mac_vnode_label_free(imgp-&gt;ip_scriptlabelp);</span><br><span class="line">            &#125;</span><br><span class="line">            imgp-&gt;ip_scriptlabelp = mac_vnode_label_alloc();</span><br><span class="line">            <span class="keyword">if</span> (imgp-&gt;ip_scriptlabelp == NULL) &#123;</span><br><span class="line">                error = ENOMEM;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mac_vnode_label_copy(imgp-&gt;ip_vp-&gt;v_label,</span><br><span class="line">                imgp-&gt;ip_scriptlabelp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Take a ref of the script vnode for later use.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (imgp-&gt;ip_scriptvp) &#123;</span><br><span class="line">                vnode_put(imgp-&gt;ip_scriptvp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (vnode_getwithref(imgp-&gt;ip_vp) == <span class="number">0</span>) &#123;</span><br><span class="line">                imgp-&gt;ip_scriptvp = imgp-&gt;ip_vp;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">            nameidone(ndp);</span><br><span class="line"></span><br><span class="line">            vnode_put(imgp-&gt;ip_vp);</span><br><span class="line">            imgp-&gt;ip_vp = NULL;     <span class="comment">/* already put */</span></span><br><span class="line">            imgp-&gt;ip_ndp = NULL; <span class="comment">/* already nameidone */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Use excpath, which exec_shell_imgact reset to the interpreter */</span></span><br><span class="line">            NDINIT(ndp, LOOKUP, OP_LOOKUP, FOLLOW | LOCKLEAF,</span><br><span class="line">                UIO_SYSSPACE, CAST_USER_ADDR_T(excpath), imgp-&gt;ip_vfs_context);</span><br><span class="line"></span><br><span class="line">            proc_transend(p, <span class="number">0</span>);</span><br><span class="line">            goto again;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (imgp-&gt;ip_flags &amp; IMGPF_INTERPRET &amp;&amp; ndp-&gt;ni_vp) &#123;</span><br><span class="line">            AUDIT_ARG(vnpath, ndp-&gt;ni_vp, ARG_VNODE2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Call out to allow 3rd party notification of exec.</span></span><br><span class="line"><span class="comment">         * Ignore result of kauth_authorize_fileop call.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (kauth_authorize_fileop_has_listeners()) &#123;</span><br><span class="line">            kauth_authorize_fileop(vfs_context_ucred(imgp-&gt;ip_vfs_context),</span><br><span class="line">                KAUTH_FILEOP_EXEC,</span><br><span class="line">                (uintptr_t)ndp-&gt;ni_vp, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">bad:</span><br><span class="line">    proc_transend(p, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">bad_notrans:</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_strings) &#123;</span><br><span class="line">        execargs_free(imgp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_ndp) &#123;</span><br><span class="line">        nameidone(imgp-&gt;ip_ndp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ndp) &#123;</span><br><span class="line">        FREE(ndp, M_TEMP);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于<a href="https://linux.die.net/man/1/namei" target="_blank" rel="noopener">namei</a>的相关内容可查看这里。  </p>
<p><code>exec_activate_image</code>函数的主要作用是进行二进制文件的查找和加载到内存中，最后由<code>execsw</code>数组中的函数指针来执行具体的二进制加载，其中<code>execsw</code>的结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct execsw &#123;</span><br><span class="line">    int(*const ex_imgact)(struct image_params *);</span><br><span class="line">    const char *ex_name;</span><br><span class="line">&#125;const execsw[] = &#123;</span><br><span class="line">    &#123; exec_mach_imgact, &quot;Mach-o Binary&quot; &#125;,</span><br><span class="line">    &#123; exec_fat_imgact, &quot;Fat Binary&quot; &#125;,</span><br><span class="line">    &#123; exec_shell_imgact, &quot;Interpreter Script&quot; &#125;,</span><br><span class="line">    &#123; NULL, NULL&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><code>exec_activate_image</code>函数的流程如下：</p>
<ol>
<li>从vfs上下文环境中获得 proc_t。  </li>
<li>分配内核内存用于保存用户空间的参数和镜像的第一个页面。  </li>
<li>保存程序路径并修正参数。  </li>
<li>使用namei() 和 NDINIT宏来获取镜像文件。</li>
<li>确保进程中没有其他线程执行exit，并标记二进制文件转换开始。  </li>
<li>权限检查。  </li>
<li>将第一个页面加载到内存中。 </li>
<li>遍历execsw数组，执行对应的函数。</li>
</ol>
<p>这里是<code>MachO</code>类型，所以执行<code>exec_mach_imgact</code></p>
<h4 id="exec-mach-imgact"><a href="#exec-mach-imgact" class="headerlink" title="exec_mach_imgact"></a>exec_mach_imgact</h4><p>该函数比较长，这里不在给出源码，占用篇幅。该函数主要流程如下：</p>
<ol>
<li>分析macho的头文件架构（64or32）。  </li>
<li>对二进制进行分析评估是否满足加载要求，其中包括cpu类型等</li>
<li>针对<code>__\mac_execve</code>函数中的vfork标记来创建任务和线程（vfork不会创建任务和线程）。</li>
<li>调用<code>load_machfile</code>加载二进制文件</li>
</ol>
<h4 id="load-machfile"><a href="#load-machfile" class="headerlink" title="load_machfile"></a>load_machfile</h4><p><code>load_machfile</code>函数负责设置内存映射，并最终加载各种<code>LC_SEGMENT</code>命令加载的内容。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line">oad_return_t</span><br><span class="line">load_machfile(</span><br><span class="line">    struct image_params     *imgp,<span class="comment">//镜像参数</span></span><br><span class="line">    struct mach_header      *header,</span><br><span class="line">    thread_t                thread,<span class="comment">//current_thread</span></span><br><span class="line">    vm_map_t                *mapp,</span><br><span class="line">    load_result_t           *result<span class="comment">//加载结果</span></span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    struct vnode            *vp = imgp-&gt;ip_vp;</span><br><span class="line">    off_t                   file_offset = imgp-&gt;ip_arch_offset;</span><br><span class="line">    off_t                   macho_size = imgp-&gt;ip_arch_size;</span><br><span class="line">    off_t                   file_size = imgp-&gt;ip_vattr-&gt;va_data_size;</span><br><span class="line">    pmap_t                  pmap = <span class="number">0</span>;       <span class="comment">/* protected by create_map */</span></span><br><span class="line">    vm_map_t                map;</span><br><span class="line">    load_result_t           myresult;</span><br><span class="line">    load_return_t           lret;</span><br><span class="line">    boolean_t enforce_hard_pagezero = TRUE;</span><br><span class="line">    int in_exec = (imgp-&gt;ip_flags &amp; IMGPF_EXEC);</span><br><span class="line">    task_t task = current_task();</span><br><span class="line">    int64_t                 aslr_page_offset = <span class="number">0</span>;</span><br><span class="line">    int64_t                 dyld_aslr_page_offset = <span class="number">0</span>;</span><br><span class="line">    int64_t                 aslr_section_size = <span class="number">0</span>;</span><br><span class="line">    int64_t                 aslr_section_offset = <span class="number">0</span>;</span><br><span class="line">    kern_return_t           kret;</span><br><span class="line">    unsigned int            pmap_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (macho_size &gt; file_size) &#123;</span><br><span class="line">        <span class="keyword">return</span> LOAD_BADMACHO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result-&gt;is_64bit_addr = ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT_ADDR) == IMGPF_IS_64BIT_ADDR);</span><br><span class="line">    result-&gt;is_64bit_data = ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT_DATA) == IMGPF_IS_64BIT_DATA);</span><br><span class="line">#if defined(HAS_APPLE_PAC)</span><br><span class="line">    pmap_flags |= (imgp-&gt;ip_flags &amp; IMGPF_NOJOP) ? PMAP_CREATE_DISABLE_JOP : <span class="number">0</span>;</span><br><span class="line">#endif /* defined(HAS_APPLE_PAC) */</span><br><span class="line">    pmap_flags |= result-&gt;is_64bit_addr ? PMAP_CREATE_64BIT : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    task_t ledger_task;</span><br><span class="line">    <span class="keyword">if</span> (imgp-&gt;ip_new_thread) &#123;</span><br><span class="line">        ledger_task = get_threadtask(imgp-&gt;ip_new_thread);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ledger_task = task;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建新的pmap</span></span><br><span class="line">    pmap = pmap_create_options(get_task_ledger(ledger_task),</span><br><span class="line">        (vm_map_size_t) <span class="number">0</span>,</span><br><span class="line">        pmap_flags);</span><br><span class="line">    <span class="keyword">if</span> (pmap == NULL) &#123;</span><br><span class="line">        <span class="keyword">return</span> LOAD_RESOURCE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建新的vmmap</span></span><br><span class="line">    map = vm_map_create(pmap,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        vm_compute_max_offset(result-&gt;is_64bit_addr),</span><br><span class="line">        TRUE);</span><br><span class="line"></span><br><span class="line">#if defined(__arm64__)</span><br><span class="line">    <span class="keyword">if</span> (result-&gt;is_64bit_addr) &#123;</span><br><span class="line">        <span class="comment">/* enforce 16KB alignment of VM map entries */</span></span><br><span class="line">        vm_map_set_page_shift(map, SIXTEENK_PAGE_SHIFT);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vm_map_set_page_shift(map, page_shift_user32);</span><br><span class="line">    &#125;</span><br><span class="line">#elif (__ARM_ARCH_7K__ &gt;= 2) &amp;&amp; defined(PLATFORM_WatchOS)</span><br><span class="line">    <span class="comment">/* enforce 16KB alignment for watch targets with new ABI */</span></span><br><span class="line">    vm_map_set_page_shift(map, SIXTEENK_PAGE_SHIFT);</span><br><span class="line">#endif /* __arm64__ */</span><br><span class="line"></span><br><span class="line">#ifndef CONFIG_ENFORCE_SIGNED_CODE</span><br><span class="line">    <span class="comment">/* This turns off faulting for executable pages, which allows</span></span><br><span class="line"><span class="comment">     * to circumvent Code Signing Enforcement. The per process</span></span><br><span class="line"><span class="comment">     * flag (CS_ENFORCEMENT) is not set yet, but we can use the</span></span><br><span class="line"><span class="comment">     * global flag.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!cs_process_global_enforcement() &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION)) &#123;</span><br><span class="line">        vm_map_disable_NX(map);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Message Trace or log that this is happening</span></span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Forcibly disallow execution from data pages on even if the arch</span></span><br><span class="line"><span class="comment">     * normally permits it. */</span></span><br><span class="line">    <span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC)) &#123;</span><br><span class="line">        vm_map_disallow_data_exec(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Compute a random offset for ASLR, and an independent random offset for dyld.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//计算ASLR</span></span><br><span class="line">    <span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</span><br><span class="line">        vm_map_get_max_aslr_slide_section(map, &amp;aslr_section_offset, &amp;aslr_section_size);</span><br><span class="line">        aslr_section_offset = (random() % aslr_section_offset) * aslr_section_size;</span><br><span class="line"></span><br><span class="line">        aslr_page_offset = random();</span><br><span class="line">        aslr_page_offset %= vm_map_get_max_aslr_slide_pages(map);</span><br><span class="line">        aslr_page_offset &lt;&lt;= vm_map_page_shift(map);</span><br><span class="line"></span><br><span class="line">        dyld_aslr_page_offset = random();</span><br><span class="line">        dyld_aslr_page_offset %= vm_map_get_max_loader_aslr_slide_pages(map);</span><br><span class="line">        dyld_aslr_page_offset &lt;&lt;= vm_map_page_shift(map);</span><br><span class="line"></span><br><span class="line">        aslr_page_offset += aslr_section_offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        result = &amp;myresult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *result = load_result_null;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * re-set the bitness on the load result since we cleared the load result above.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    result-&gt;is_64bit_addr = ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT_ADDR) == IMGPF_IS_64BIT_ADDR);</span><br><span class="line">    result-&gt;is_64bit_data = ((imgp-&gt;ip_flags &amp; IMGPF_IS_64BIT_DATA) == IMGPF_IS_64BIT_DATA);</span><br><span class="line">    <span class="comment">//解析加载对应的macho</span></span><br><span class="line">    lret = parse_machfile(vp, map, thread, header, file_offset, macho_size,</span><br><span class="line">        <span class="number">0</span>, aslr_page_offset, dyld_aslr_page_offset, result,</span><br><span class="line">        NULL, imgp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载失败，返还内存    </span></span><br><span class="line">    <span class="keyword">if</span> (lret != LOAD_SUCCESS) &#123;</span><br><span class="line">        vm_map_deallocate(map); <span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">        <span class="keyword">return</span> lret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#if __x86_64__</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * On x86, for compatibility, don't enforce the hard page-zero restriction for 32-bit binaries.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!result-&gt;is_64bit_addr) &#123;</span><br><span class="line">        enforce_hard_pagezero = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * For processes with IMGPF_HIGH_BITS_ASLR, add a few random high bits</span></span><br><span class="line"><span class="comment">     * to the start address for "anywhere" memory allocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">#define VM_MAP_HIGH_START_BITS_COUNT 8</span><br><span class="line">#define VM_MAP_HIGH_START_BITS_SHIFT 27</span><br><span class="line">    <span class="keyword">if</span> (result-&gt;is_64bit_addr &amp;&amp;</span><br><span class="line">        (imgp-&gt;ip_flags &amp; IMGPF_HIGH_BITS_ASLR)) &#123;</span><br><span class="line">        int random_bits;</span><br><span class="line">        vm_map_offset_t high_start;</span><br><span class="line"></span><br><span class="line">        random_bits = random();</span><br><span class="line">        random_bits &amp;= (<span class="number">1</span> &lt;&lt; VM_MAP_HIGH_START_BITS_COUNT) - <span class="number">1</span>;</span><br><span class="line">        high_start = (((vm_map_offset_t)random_bits)</span><br><span class="line">                &lt;&lt; VM_MAP_HIGH_START_BITS_SHIFT);</span><br><span class="line">        vm_map_set_high_start(map, high_start);</span><br><span class="line">    &#125;</span><br><span class="line">#endif /* __x86_64__ */</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Check to see if the page zero is enforced by the map-&gt;min_offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (enforce_hard_pagezero &amp;&amp;</span><br><span class="line">        (vm_map_has_hard_pagezero(map, <span class="number">0x1000</span>) == FALSE)) &#123;</span><br><span class="line">#if __arm64__</span><br><span class="line">        <span class="keyword">if</span> (!result-&gt;is_64bit_addr &amp;&amp; <span class="comment">/* not 64-bit address space */</span></span><br><span class="line">            !(header-&gt;flags &amp; MH_PIE) &amp;&amp;          <span class="comment">/* not PIE */</span></span><br><span class="line">            (vm_map_page_shift(map) != FOURK_PAGE_SHIFT ||</span><br><span class="line">            PAGE_SHIFT != FOURK_PAGE_SHIFT) &amp;&amp;  <span class="comment">/* page size != 4KB */</span></span><br><span class="line">            result-&gt;has_pagezero &amp;&amp;     <span class="comment">/* has a "soft" page zero */</span></span><br><span class="line">            fourk_binary_compatibility_unsafe) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * For backwards compatibility of "4K" apps on</span></span><br><span class="line"><span class="comment">             * a 16K system, do not enforce a hard page zero...</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">#endif /* __arm64__ */</span><br><span class="line">        &#123;</span><br><span class="line">            vm_map_deallocate(map); <span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">            <span class="keyword">return</span> LOAD_BADMACHO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vm_commit_pagezero_status(map);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If this is an exec, then we are going to destroy the old</span></span><br><span class="line"><span class="comment">     * task, and it's correct to halt it; if it's spawn, the</span></span><br><span class="line"><span class="comment">     * task is not yet running, and it makes no sense.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (in_exec) &#123;</span><br><span class="line">        proc_t p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Mark the task as halting and start the other</span></span><br><span class="line"><span class="comment">         * threads towards terminating themselves.  Then</span></span><br><span class="line"><span class="comment">         * make sure any threads waiting for a process</span></span><br><span class="line"><span class="comment">         * transition get informed that we are committed to</span></span><br><span class="line"><span class="comment">         * this transition, and then finally complete the</span></span><br><span class="line"><span class="comment">         * task halting (wait for threads and then cleanup</span></span><br><span class="line"><span class="comment">         * task resources).</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">NOTE:</span> task_start_halt() makes sure that no new</span></span><br><span class="line"><span class="comment">         * threads are created in the task during the transition.</span></span><br><span class="line"><span class="comment">         * We need to mark the workqueue as exiting before we</span></span><br><span class="line"><span class="comment">         * wait for threads to terminate (at the end of which</span></span><br><span class="line"><span class="comment">         * we no longer have a prohibition on thread creation).</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Finally, clean up any lingering workqueue data structures</span></span><br><span class="line"><span class="comment">         * that may have been left behind by the workqueue threads</span></span><br><span class="line"><span class="comment">         * as they exited (and then clean up the work queue itself).</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        kret = task_start_halt(task);</span><br><span class="line">        <span class="keyword">if</span> (kret != KERN_SUCCESS) &#123;</span><br><span class="line">            vm_map_deallocate(map); <span class="comment">/* will lose pmap reference too */</span></span><br><span class="line">            <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        proc_transcommit(p, <span class="number">0</span>);</span><br><span class="line">        workq_mark_exiting(p);</span><br><span class="line">        task_complete_halt(task);</span><br><span class="line">        workq_exit(p);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Roll up accounting info to new task. The roll up is done after</span></span><br><span class="line"><span class="comment">         * task_complete_halt to make sure the thread accounting info is</span></span><br><span class="line"><span class="comment">         * rolled up to current_task.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        task_rollup_accounting_info(get_threadtask(thread), task);</span><br><span class="line">    &#125;</span><br><span class="line">    *mapp = map;</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_32BIT_TELEMETRY</span><br><span class="line">    <span class="keyword">if</span> (!result-&gt;is_64bit_data) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * This may not need to be an AST; we merely need to ensure that</span></span><br><span class="line"><span class="comment">         * we gather telemetry at the point where all of the information</span></span><br><span class="line"><span class="comment">         * that we want has been added to the process.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        task_set_32bit_log_flag(get_threadtask(thread));</span><br><span class="line">        act_set_astbsd(thread);</span><br><span class="line">    &#125;</span><br><span class="line">#endif /* CONFIG_32BIT_TELEMETRY */</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> LOAD_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数主要分为以下几个部分：</p>
<ol>
<li>进行内存映射。</li>
<li>完善一些安全性设置，包括ASLR,禁用数据段执行。</li>
<li>调用<code>parse_machfile</code>，负责实际的加载工作</li>
<li>如果加载失败则返还前面映射内存</li>
<li>否则更新新的内存对象<code>mapp</code><h4 id="parse-machfile"><a href="#parse-machfile" class="headerlink" title="parse_machfile"></a>parse_machfile</h4></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span></span><br><span class="line">load_return_t</span><br><span class="line">parse_machfile(</span><br><span class="line">    struct vnode            *vp,<span class="comment">//imgp中的vnode</span></span><br><span class="line">    vm_map_t                map,<span class="comment">//load_machfile的初始化映射</span></span><br><span class="line">    thread_t                thread,</span><br><span class="line">    struct mach_header      *header,</span><br><span class="line">    off_t                   file_offset,<span class="comment">//文件偏移</span></span><br><span class="line">    off_t                   macho_size,<span class="comment">//大小</span></span><br><span class="line">    int                     depth,<span class="comment">//递归深度</span></span><br><span class="line">    int64_t                 aslr_offset,<span class="comment">//aslr</span></span><br><span class="line">    int64_t                 dyld_aslr_offset,</span><br><span class="line">    load_result_t           *result,</span><br><span class="line">    load_result_t           *binresult,</span><br><span class="line">    struct image_params     *imgp</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t                ncmds;</span><br><span class="line">    struct load_command     *lcp;</span><br><span class="line">    struct dylinker_command *dlp = <span class="number">0</span>;</span><br><span class="line">    integer_t               dlarchbits = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">void</span> *                  control;</span><br><span class="line">    load_return_t           ret = LOAD_SUCCESS;</span><br><span class="line">    <span class="keyword">void</span> *                  addr;</span><br><span class="line">    vm_size_t               alloc_size, cmds_size;</span><br><span class="line">    size_t                  offset;</span><br><span class="line">    size_t                  oldoffset;      <span class="comment">/* for overflow check */</span></span><br><span class="line">    int                     pass;</span><br><span class="line">    proc_t                  p = vfs_context_proc(imgp-&gt;ip_vfs_context);</span><br><span class="line">    int                     error;</span><br><span class="line">    int                     resid = <span class="number">0</span>;</span><br><span class="line">    int                     spawn = (imgp-&gt;ip_flags &amp; IMGPF_SPAWN);</span><br><span class="line">    int                     vfexec = (imgp-&gt;ip_flags &amp; IMGPF_VFORK_EXEC);</span><br><span class="line">    size_t                  mach_header_sz = sizeof(struct mach_header);</span><br><span class="line">    boolean_t               abi64;</span><br><span class="line">    boolean_t               got_code_signatures = FALSE;</span><br><span class="line">    boolean_t               found_header_segment = FALSE;</span><br><span class="line">    boolean_t               found_xhdr = FALSE;</span><br><span class="line">    boolean_t               found_version_cmd = FALSE;</span><br><span class="line">    int64_t                 slide = <span class="number">0</span>;</span><br><span class="line">    boolean_t               dyld_no_load_addr = FALSE;</span><br><span class="line">    boolean_t               is_dyld = FALSE;</span><br><span class="line">    vm_map_offset_t         effective_page_mask = MAX(PAGE_MASK, vm_map_page_mask(map));</span><br><span class="line">#if __arm64__</span><br><span class="line">    uint32_t                pagezero_end = <span class="number">0</span>;</span><br><span class="line">    uint32_t                executable_end = <span class="number">0</span>;</span><br><span class="line">    uint32_t                writable_start = <span class="number">0</span>;</span><br><span class="line">    vm_map_size_t           effective_page_size;</span><br><span class="line"></span><br><span class="line">    effective_page_size = MAX(PAGE_SIZE, vm_map_page_size(map));</span><br><span class="line">#endif /* __arm64__ */</span><br><span class="line">    <span class="comment">//文件类型检测</span></span><br><span class="line">    <span class="keyword">if</span> (header-&gt;magic == MH_MAGIC_64 ||</span><br><span class="line">        header-&gt;magic == MH_CIGAM_64) &#123;</span><br><span class="line">        mach_header_sz = sizeof(struct mach_header_64);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *    Break infinite recursion</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//深度&gt;1返回失败，老版本里面可能是6</span></span><br><span class="line">    <span class="keyword">if</span> (depth &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    depth++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *    Check to see if right machine type.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//验证架构</span></span><br><span class="line">    <span class="keyword">if</span> (((cpu_type_t)(header-&gt;cputype &amp; ~CPU_ARCH_MASK) != (cpu_type() &amp; ~CPU_ARCH_MASK)) ||</span><br><span class="line">        !grade_binary(header-&gt;cputype,</span><br><span class="line">        header-&gt;cpusubtype &amp; ~CPU_SUBTYPE_MASK, TRUE)) &#123;</span><br><span class="line">        <span class="keyword">return</span> LOAD_BADARCH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    abi64 = ((header-&gt;cputype &amp; CPU_ARCH_ABI64) == CPU_ARCH_ABI64);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (header-&gt;filetype) &#123;</span><br><span class="line">    <span class="comment">//只有深度为1</span></span><br><span class="line">    <span class="keyword">case</span> MH_EXECUTE:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (depth != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">#if CONFIG_EMBEDDED</span><br><span class="line">        <span class="keyword">if</span> (header-&gt;flags &amp; MH_DYLDLINK) &#123;</span><br><span class="line">            <span class="comment">/* Check properties of dynamic executables */</span></span><br><span class="line">            <span class="keyword">if</span> (!(header-&gt;flags &amp; MH_PIE) &amp;&amp; pie_required(header-&gt;cputype, header-&gt;cpusubtype &amp; ~CPU_SUBTYPE_MASK)) &#123;</span><br><span class="line">                <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">            &#125;</span><br><span class="line">            result-&gt;needs_dynlinker = TRUE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* Check properties of static executables (disallowed except for development) */</span></span><br><span class="line">#if !(DEVELOPMENT || DEBUG)</span><br><span class="line">            <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">#endif /* CONFIG_EMBEDDED */</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">//只有深度为2</span></span><br><span class="line">    <span class="keyword">case</span> MH_DYLINKER:</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (depth != <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        is_dyld = TRUE;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> LOAD_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *    Get the pager for the file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    control = ubc_getobject(vp, UBC_FLAGS_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ensure header + sizeofcmds falls within the file */</span></span><br><span class="line">    <span class="keyword">if</span> (os_add_overflow(mach_header_sz, header-&gt;sizeofcmds, &amp;cmds_size) ||</span><br><span class="line">        (off_t)cmds_size &gt; macho_size ||</span><br><span class="line">        round_page_overflow(cmds_size, &amp;alloc_size)) &#123;</span><br><span class="line">        <span class="keyword">return</span> LOAD_BADMACHO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Map the load commands into kernel memory.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    addr = kalloc(alloc_size);</span><br><span class="line">    <span class="keyword">if</span> (addr == NULL) &#123;</span><br><span class="line">        <span class="keyword">return</span> LOAD_NOSPACE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//把所有load command 都加载到内存</span></span><br><span class="line">    error = vn_rdwr(UIO_READ, vp, addr, alloc_size, file_offset,</span><br><span class="line">        UIO_SYSSPACE, <span class="number">0</span>, vfs_context_ucred(imgp-&gt;ip_vfs_context), &amp;resid, p);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        kfree(addr, alloc_size);</span><br><span class="line">        <span class="keyword">return</span> LOAD_IOERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resid) &#123;</span><br><span class="line">        <span class="comment">/* We must be able to read in as much as the mach_header indicated */</span></span><br><span class="line">        kfree(addr, alloc_size);</span><br><span class="line">        <span class="keyword">return</span> LOAD_BADMACHO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *    For PIE and dyld, slide everything by the ASLR offset.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//为pie和dyld 设置aslr</span></span><br><span class="line">    <span class="keyword">if</span> ((header-&gt;flags &amp; MH_PIE) || is_dyld) &#123;</span><br><span class="line">        slide = aslr_offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行3轮扫码命令</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  Scan through the commands, processing each one as necessary.</span></span><br><span class="line"><span class="comment">     *  We parse in three passes through the headers:</span></span><br><span class="line"><span class="comment">     *  0: determine if TEXT and DATA boundary can be page-aligned</span></span><br><span class="line"><span class="comment">     *  1: thread state, uuid, code signature</span></span><br><span class="line"><span class="comment">     *  2: segments</span></span><br><span class="line"><span class="comment">     *  3: dyld, encryption, check entry point</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    boolean_t slide_realign = FALSE;</span><br><span class="line">#if __arm64__</span><br><span class="line">    <span class="keyword">if</span> (!abi64) &#123;</span><br><span class="line">        slide_realign = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (pass = <span class="number">0</span>; pass &lt;= <span class="number">3</span>; pass++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pass == <span class="number">0</span> &amp;&amp; !slide_realign &amp;&amp; !is_dyld) &#123;</span><br><span class="line">            <span class="comment">/* if we dont need to realign the slide or determine dyld's load</span></span><br><span class="line"><span class="comment">             * address, pass 0 can be skipped */</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pass == <span class="number">1</span>) &#123;</span><br><span class="line">#if __arm64__</span><br><span class="line"><span class="comment">//pass1:</span></span><br><span class="line">            boolean_t       is_pie;</span><br><span class="line">            int64_t         adjust;</span><br><span class="line"></span><br><span class="line">            is_pie = ((header-&gt;flags &amp; MH_PIE) != <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (pagezero_end != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                pagezero_end &lt; effective_page_size) &#123;</span><br><span class="line">                <span class="comment">/* need at least 1 page for PAGEZERO */</span></span><br><span class="line">                adjust = effective_page_size;</span><br><span class="line">                MACHO_PRINTF((<span class="string">"pagezero boundary at "</span></span><br><span class="line">                    <span class="string">"0x%llx; adjust slide from "</span></span><br><span class="line">                    <span class="string">"0x%llx to 0x%llx%s\n"</span>,</span><br><span class="line">                    (uint64_t) pagezero_end,</span><br><span class="line">                    slide,</span><br><span class="line">                    slide + adjust,</span><br><span class="line">                    (is_pie</span><br><span class="line">                    ? <span class="string">""</span></span><br><span class="line">                    : <span class="string">" BUT NO PIE ****** :-("</span>)));</span><br><span class="line">                <span class="keyword">if</span> (is_pie) &#123;</span><br><span class="line">                    slide += adjust;</span><br><span class="line">                    pagezero_end += adjust;</span><br><span class="line">                    executable_end += adjust;</span><br><span class="line">                    writable_start += adjust;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pagezero_end != <span class="number">0</span>) &#123;</span><br><span class="line">                result-&gt;has_pagezero = TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (executable_end == writable_start &amp;&amp;</span><br><span class="line">                (executable_end &amp; effective_page_mask) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                (executable_end &amp; FOURK_PAGE_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * The TEXT/DATA boundary is 4K-aligned but</span></span><br><span class="line"><span class="comment">                 * not page-aligned.  Adjust the slide to make</span></span><br><span class="line"><span class="comment">                 * it page-aligned and avoid having a page</span></span><br><span class="line"><span class="comment">                 * with both write and execute permissions.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                adjust =</span><br><span class="line">                    (effective_page_size -</span><br><span class="line">                    (executable_end &amp; effective_page_mask));</span><br><span class="line">                MACHO_PRINTF((<span class="string">"page-unaligned X-W boundary at "</span></span><br><span class="line">                    <span class="string">"0x%llx; adjust slide from "</span></span><br><span class="line">                    <span class="string">"0x%llx to 0x%llx%s\n"</span>,</span><br><span class="line">                    (uint64_t) executable_end,</span><br><span class="line">                    slide,</span><br><span class="line">                    slide + adjust,</span><br><span class="line">                    (is_pie</span><br><span class="line">                    ? <span class="string">""</span></span><br><span class="line">                    : <span class="string">" BUT NO PIE ****** :-("</span>)));</span><br><span class="line">                <span class="keyword">if</span> (is_pie) &#123;</span><br><span class="line">                    slide += adjust;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">#endif /* __arm64__ */</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (dyld_no_load_addr &amp;&amp; binresult) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * The dyld Mach-O does not specify a load address. Try to locate</span></span><br><span class="line"><span class="comment">                 * it right after the main binary. If binresult == NULL, load</span></span><br><span class="line"><span class="comment">                 * directly to the given slide.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                slide = vm_map_round_page(slide + binresult-&gt;max_vm_addr, effective_page_mask);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Check that the entry point is contained in an executable segments</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (pass == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (depth == <span class="number">1</span> &amp;&amp; imgp &amp;&amp; (imgp-&gt;ip_flags &amp; IMGPF_DRIVER)) &#123;</span><br><span class="line">                <span class="comment">/* Driver binaries must have driverkit platform */</span></span><br><span class="line">                <span class="keyword">if</span> (result-&gt;ip_platform == PLATFORM_DRIVERKIT) &#123;</span><br><span class="line">                    <span class="comment">/* Driver binaries have no entry point */</span></span><br><span class="line">                    ret = setup_driver_main(thread, slide, result);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ret = LOAD_FAILURE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!result-&gt;using_lcmain &amp;&amp; result-&gt;validentry == <span class="number">0</span>) &#123;</span><br><span class="line">                ret = LOAD_FAILURE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret != KERN_SUCCESS) &#123;</span><br><span class="line">                thread_state_initialize(thread);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Check that some segment maps the start of the mach-o file, which is</span></span><br><span class="line"><span class="comment">         * needed by the dynamic loader to read the mach headers, etc.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (found_header_segment == FALSE)) &#123;</span><br><span class="line">            ret = LOAD_BADMACHO;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Loop through each of the load_commands indicated by the</span></span><br><span class="line"><span class="comment">         * Mach-O header; if an absurd value is provided, we just</span></span><br><span class="line"><span class="comment">         * run off the end of the reserved section by incrementing</span></span><br><span class="line"><span class="comment">         * the offset too far, so we are implicitly fail-safe.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        offset = mach_header_sz;</span><br><span class="line">        ncmds = header-&gt;ncmds;</span><br><span class="line">        <span class="comment">//进入cmd加载环节</span></span><br><span class="line">        <span class="keyword">while</span> (ncmds--) &#123;</span><br><span class="line">            <span class="comment">/* ensure enough space for a minimal load command */</span></span><br><span class="line">            <span class="keyword">if</span> (offset + sizeof(struct load_command) &gt; cmds_size) &#123;</span><br><span class="line">                ret = LOAD_BADMACHO;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *    Get a pointer to the command.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            lcp = (struct load_command *)(addr + offset);</span><br><span class="line">            oldoffset = offset;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Perform prevalidation of the struct load_command</span></span><br><span class="line"><span class="comment">             * before we attempt to use its contents.  Invalid</span></span><br><span class="line"><span class="comment">             * values are ones which result in an overflow, or</span></span><br><span class="line"><span class="comment">             * which can not possibly be valid commands, or which</span></span><br><span class="line"><span class="comment">             * straddle or exist past the reserved section at the</span></span><br><span class="line"><span class="comment">             * start of the image.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (os_add_overflow(offset, lcp-&gt;cmdsize, &amp;offset) ||</span><br><span class="line">                lcp-&gt;cmdsize &lt; sizeof(struct load_command) ||</span><br><span class="line">                offset &gt; cmds_size) &#123;</span><br><span class="line">                ret = LOAD_BADMACHO;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * Act on struct load_command's for which kernel</span></span><br><span class="line"><span class="comment">             * intervention is required.</span></span><br><span class="line"><span class="comment">             * Note that each load command implementation is expected to validate</span></span><br><span class="line"><span class="comment">             * that lcp-&gt;cmdsize is large enough to fit its specific struct type</span></span><br><span class="line"><span class="comment">             * before dereferencing fields not covered by struct load_command.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">switch</span> (lcp-&gt;cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> LC_SEGMENT: &#123;</span><br><span class="line">                struct segment_command *scp = (struct segment_command *) lcp;</span><br><span class="line">                <span class="keyword">if</span> (scp-&gt;cmdsize &lt; sizeof(*scp)) &#123;</span><br><span class="line">                    ret = LOAD_BADMACHO;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_dyld &amp;&amp; scp-&gt;vmaddr == <span class="number">0</span> &amp;&amp; scp-&gt;fileoff == <span class="number">0</span>) &#123;</span><br><span class="line">                        dyld_no_load_addr = TRUE;</span><br><span class="line">                        <span class="keyword">if</span> (!slide_realign) &#123;</span><br><span class="line">                            <span class="comment">/* got what we need, bail early on pass 0 */</span></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">#if __arm64__</span><br><span class="line">                    assert(!abi64);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (scp-&gt;initprot == <span class="number">0</span> &amp;&amp; scp-&gt;maxprot == <span class="number">0</span> &amp;&amp; scp-&gt;vmaddr == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">/* PAGEZERO */</span></span><br><span class="line">                        <span class="keyword">if</span> (os_add3_overflow(scp-&gt;vmaddr, scp-&gt;vmsize, slide, &amp;pagezero_end)) &#123;</span><br><span class="line">                            ret = LOAD_BADMACHO;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (scp-&gt;initprot &amp; VM_PROT_EXECUTE) &#123;</span><br><span class="line">                        <span class="comment">/* TEXT */</span></span><br><span class="line">                        <span class="keyword">if</span> (os_add3_overflow(scp-&gt;vmaddr, scp-&gt;vmsize, slide, &amp;executable_end)) &#123;</span><br><span class="line">                            ret = LOAD_BADMACHO;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (scp-&gt;initprot &amp; VM_PROT_WRITE) &#123;</span><br><span class="line">                        <span class="comment">/* DATA */</span></span><br><span class="line">                        <span class="keyword">if</span> (os_add_overflow(scp-&gt;vmaddr, slide, &amp;writable_start)) &#123;</span><br><span class="line">                            ret = LOAD_BADMACHO;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">#endif /* __arm64__ */</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; !strncmp(scp-&gt;segname, <span class="string">"__XHDR"</span>, sizeof(scp-&gt;segname))) &#123;</span><br><span class="line">                    found_xhdr = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (abi64) &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Having an LC_SEGMENT command for the</span></span><br><span class="line"><span class="comment">                     * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    ret = LOAD_BADMACHO;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ret = load_segment(lcp,</span><br><span class="line">                    header-&gt;filetype,</span><br><span class="line">                    control,</span><br><span class="line">                    file_offset,</span><br><span class="line">                    macho_size,</span><br><span class="line">                    vp,</span><br><span class="line">                    map,</span><br><span class="line">                    slide,</span><br><span class="line">                    result);</span><br><span class="line">                <span class="keyword">if</span> (ret == LOAD_SUCCESS &amp;&amp; scp-&gt;fileoff == <span class="number">0</span> &amp;&amp; scp-&gt;filesize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/* Enforce a single segment mapping offset zero, with R+X</span></span><br><span class="line"><span class="comment">                     * protection. */</span></span><br><span class="line">                    <span class="keyword">if</span> (found_header_segment ||</span><br><span class="line">                        ((scp-&gt;initprot &amp; (VM_PROT_READ | VM_PROT_EXECUTE)) != (VM_PROT_READ | VM_PROT_EXECUTE))) &#123;</span><br><span class="line">                        ret = LOAD_BADMACHO;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    found_header_segment = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> LC_SEGMENT_64: &#123;</span><br><span class="line">                struct segment_command_64 *scp64 = (struct segment_command_64 *) lcp;</span><br><span class="line">                <span class="keyword">if</span> (scp64-&gt;cmdsize &lt; sizeof(*scp64)) &#123;</span><br><span class="line">                    ret = LOAD_BADMACHO;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_dyld &amp;&amp; scp64-&gt;vmaddr == <span class="number">0</span> &amp;&amp; scp64-&gt;fileoff == <span class="number">0</span>) &#123;</span><br><span class="line">                        dyld_no_load_addr = TRUE;</span><br><span class="line">                        <span class="keyword">if</span> (!slide_realign) &#123;</span><br><span class="line">                            <span class="comment">/* got what we need, bail early on pass 0 */</span></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; !strncmp(scp64-&gt;segname, <span class="string">"__XHDR"</span>, sizeof(scp64-&gt;segname))) &#123;</span><br><span class="line">                    found_xhdr = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">2</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!abi64) &#123;</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Having an LC_SEGMENT_64 command for the</span></span><br><span class="line"><span class="comment">                     * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    ret = LOAD_BADMACHO;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ret = load_segment(lcp,</span><br><span class="line">                    header-&gt;filetype,</span><br><span class="line">                    control,</span><br><span class="line">                    file_offset,</span><br><span class="line">                    macho_size,</span><br><span class="line">                    vp,</span><br><span class="line">                    map,</span><br><span class="line">                    slide,</span><br><span class="line">                    result);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ret == LOAD_SUCCESS &amp;&amp; scp64-&gt;fileoff == <span class="number">0</span> &amp;&amp; scp64-&gt;filesize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/* Enforce a single segment mapping offset zero, with R+X</span></span><br><span class="line"><span class="comment">                     * protection. */</span></span><br><span class="line">                    <span class="keyword">if</span> (found_header_segment ||</span><br><span class="line">                        ((scp64-&gt;initprot &amp; (VM_PROT_READ | VM_PROT_EXECUTE)) != (VM_PROT_READ | VM_PROT_EXECUTE))) &#123;</span><br><span class="line">                        ret = LOAD_BADMACHO;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    found_header_segment = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> LC_UNIXTHREAD:</span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ret = load_unixthread(</span><br><span class="line">                    (struct thread_command *) lcp,</span><br><span class="line">                    thread,</span><br><span class="line">                    slide,</span><br><span class="line">                    result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LC_MAIN:</span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (depth != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ret = load_main(</span><br><span class="line">                    (struct entry_point_command *) lcp,</span><br><span class="line">                    thread,</span><br><span class="line">                    slide,</span><br><span class="line">                    result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LC_LOAD_DYLINKER:</span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ((depth == <span class="number">1</span>) &amp;&amp; (dlp == <span class="number">0</span>)) &#123;</span><br><span class="line">                    dlp = (struct dylinker_command *)lcp;</span><br><span class="line">                    dlarchbits = (header-&gt;cputype &amp; CPU_ARCH_MASK);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ret = LOAD_FAILURE;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LC_UUID:</span><br><span class="line">                <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; depth == <span class="number">1</span>) &#123;</span><br><span class="line">                    ret = load_uuid((struct uuid_command *) lcp,</span><br><span class="line">                        (char *)addr + cmds_size,</span><br><span class="line">                        result);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LC_CODE_SIGNATURE:</span><br><span class="line">                <span class="comment">/* CODE SIGNING */</span></span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* pager -&gt; uip -&gt;</span></span><br><span class="line"><span class="comment">                 *  load signatures &amp; store in uip</span></span><br><span class="line"><span class="comment">                 *  set VM object "signed_pages"</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                ret = load_code_signature(</span><br><span class="line">                    (struct linkedit_data_command *) lcp,</span><br><span class="line">                    vp,</span><br><span class="line">                    file_offset,</span><br><span class="line">                    macho_size,</span><br><span class="line">                    header-&gt;cputype,</span><br><span class="line">                    result,</span><br><span class="line">                    imgp);</span><br><span class="line">                <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</span><br><span class="line">                    printf(<span class="string">"proc %d: load code signature error %d "</span></span><br><span class="line">                        <span class="string">"for file \"%s\"\n"</span>,</span><br><span class="line">                        p-&gt;p_pid, ret, vp-&gt;v_name);</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Allow injections to be ignored on devices w/o enforcement enabled</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (!cs_process_global_enforcement()) &#123;</span><br><span class="line">                        ret = LOAD_SUCCESS; <span class="comment">/* ignore error */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    got_code_signatures = TRUE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (got_code_signatures) &#123;</span><br><span class="line">                    unsigned tainted = CS_VALIDATE_TAINTED;</span><br><span class="line">                    boolean_t valid = FALSE;</span><br><span class="line">                    vm_size_t off = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cs_debug &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                        printf(<span class="string">"validating initial pages of %s\n"</span>, vp-&gt;v_name);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (off &lt; alloc_size &amp;&amp; ret == LOAD_SUCCESS) &#123;</span><br><span class="line">                        tainted = CS_VALIDATE_TAINTED;</span><br><span class="line"></span><br><span class="line">                        valid = cs_validate_range(vp,</span><br><span class="line">                            NULL,</span><br><span class="line">                            file_offset + off,</span><br><span class="line">                            addr + off,</span><br><span class="line">                            PAGE_SIZE,</span><br><span class="line">                            &amp;tainted);</span><br><span class="line">                        <span class="keyword">if</span> (!valid || (tainted &amp; CS_VALIDATE_TAINTED)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (cs_debug) &#123;</span><br><span class="line">                                printf(<span class="string">"CODE SIGNING: %s[%d]: invalid initial page at offset %lld validated:%d tainted:%d csflags:0x%x\n"</span>,</span><br><span class="line">                                    vp-&gt;v_name, p-&gt;p_pid, (long long)(file_offset + off), valid, tainted, result-&gt;csflags);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (cs_process_global_enforcement() ||</span><br><span class="line">                                (result-&gt;csflags &amp; (CS_HARD | CS_KILL | CS_ENFORCEMENT))) &#123;</span><br><span class="line">                                ret = LOAD_FAILURE;</span><br><span class="line">                            &#125;</span><br><span class="line">                            result-&gt;csflags &amp;= ~CS_VALID;</span><br><span class="line">                        &#125;</span><br><span class="line">                        off += PAGE_SIZE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">#if CONFIG_CODE_DECRYPTION</span><br><span class="line">            <span class="keyword">case</span> LC_ENCRYPTION_INFO:</span><br><span class="line">            <span class="keyword">case</span> LC_ENCRYPTION_INFO_64:</span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ret = set_code_unprotect(</span><br><span class="line">                    (struct encryption_info_command *) lcp,</span><br><span class="line">                    addr, map, slide, vp, file_offset,</span><br><span class="line">                    header-&gt;cputype, header-&gt;cpusubtype);</span><br><span class="line">                <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</span><br><span class="line">                    os_reason_t load_failure_reason = OS_REASON_NULL;</span><br><span class="line">                    printf(<span class="string">"proc %d: set_code_unprotect() error %d "</span></span><br><span class="line">                        <span class="string">"for file \"%s\"\n"</span>,</span><br><span class="line">                        p-&gt;p_pid, ret, vp-&gt;v_name);</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Don't let the app run if it's</span></span><br><span class="line"><span class="comment">                     * encrypted but we failed to set up the</span></span><br><span class="line"><span class="comment">                     * decrypter. If the keys are missing it will</span></span><br><span class="line"><span class="comment">                     * return LOAD_DECRYPTFAIL.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (ret == LOAD_DECRYPTFAIL) &#123;</span><br><span class="line">                        <span class="comment">/* failed to load due to missing FP keys */</span></span><br><span class="line">                        proc_lock(p);</span><br><span class="line">                        p-&gt;p_lflag |= P_LTERM_DECRYPTFAIL;</span><br><span class="line">                        proc_unlock(p);</span><br><span class="line"></span><br><span class="line">                        KERNEL_DEBUG_CONSTANT(BSDDBG_CODE(DBG_BSD_PROC, BSD_PROC_EXITREASON_CREATE) | DBG_FUNC_NONE,</span><br><span class="line">                            p-&gt;p_pid, OS_REASON_EXEC, EXEC_EXIT_REASON_FAIRPLAY_DECRYPT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                        load_failure_reason = os_reason_create(OS_REASON_EXEC, EXEC_EXIT_REASON_FAIRPLAY_DECRYPT);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        KERNEL_DEBUG_CONSTANT(BSDDBG_CODE(DBG_BSD_PROC, BSD_PROC_EXITREASON_CREATE) | DBG_FUNC_NONE,</span><br><span class="line">                            p-&gt;p_pid, OS_REASON_EXEC, EXEC_EXIT_REASON_DECRYPT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                        load_failure_reason = os_reason_create(OS_REASON_EXEC, EXEC_EXIT_REASON_DECRYPT);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                     * Don't signal the process if it was forked and in a partially constructed</span></span><br><span class="line"><span class="comment">                     * state as part of a spawn -- it will just be torn down when the exec fails.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (!spawn) &#123;</span><br><span class="line">                        assert(load_failure_reason != OS_REASON_NULL);</span><br><span class="line">                        <span class="keyword">if</span> (vfexec) &#123;</span><br><span class="line">                            psignal_vfork_with_reason(p, get_threadtask(imgp-&gt;ip_new_thread), imgp-&gt;ip_new_thread, SIGKILL, load_failure_reason);</span><br><span class="line">                            load_failure_reason = OS_REASON_NULL;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            psignal_with_reason(p, SIGKILL, load_failure_reason);</span><br><span class="line">                            load_failure_reason = OS_REASON_NULL;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        os_reason_free(load_failure_reason);</span><br><span class="line">                        load_failure_reason = OS_REASON_NULL;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">#endif</span><br><span class="line">            <span class="keyword">case</span> LC_VERSION_MIN_IPHONEOS:</span><br><span class="line">            <span class="keyword">case</span> LC_VERSION_MIN_MACOSX:</span><br><span class="line">            <span class="keyword">case</span> LC_VERSION_MIN_WATCHOS:</span><br><span class="line">            <span class="keyword">case</span> LC_VERSION_MIN_TVOS: &#123;</span><br><span class="line">                struct version_min_command *vmc;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (depth != <span class="number">1</span> || pass != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                vmc = (struct version_min_command *) lcp;</span><br><span class="line">                ret = load_version(vmc, &amp;found_version_cmd, result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> LC_BUILD_VERSION: &#123;</span><br><span class="line">                <span class="keyword">if</span> (depth != <span class="number">1</span> || pass != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                struct build_version_command* bvc = (struct build_version_command*)lcp;</span><br><span class="line">                <span class="keyword">if</span> (bvc-&gt;cmdsize &lt; sizeof(*bvc)) &#123;</span><br><span class="line">                    ret = LOAD_BADMACHO;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (found_version_cmd == TRUE) &#123;</span><br><span class="line">                    ret = LOAD_BADMACHO;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                result-&gt;ip_platform = bvc-&gt;platform;</span><br><span class="line">                found_version_cmd = TRUE;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">/* Other commands are ignored by the kernel */</span></span><br><span class="line">                ret = LOAD_SUCCESS;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == LOAD_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!got_code_signatures &amp;&amp; cs_process_global_enforcement()) &#123;</span><br><span class="line">            ret = LOAD_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Make sure if we need dyld, we got it */</span></span><br><span class="line">        <span class="keyword">if</span> (result-&gt;needs_dynlinker &amp;&amp; !dlp) &#123;</span><br><span class="line">            ret = LOAD_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ret == LOAD_SUCCESS) &amp;&amp; (dlp != <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * load the dylinker, and slide it by the independent DYLD ASLR</span></span><br><span class="line"><span class="comment">             * offset regardless of the PIE-ness of the main binary.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ret = load_dylinker(dlp, dlarchbits, map, thread, depth,</span><br><span class="line">                dyld_aslr_offset, result, imgp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((ret == LOAD_SUCCESS) &amp;&amp; (depth == <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result-&gt;thread_count == <span class="number">0</span>) &#123;</span><br><span class="line">                ret = LOAD_FAILURE;</span><br><span class="line">            &#125;</span><br><span class="line">#if CONFIG_ENFORCE_SIGNED_CODE</span><br><span class="line">            <span class="keyword">if</span> (result-&gt;needs_dynlinker &amp;&amp; !(result-&gt;csflags &amp; CS_DYLD_PLATFORM)) &#123;</span><br><span class="line">                ret = LOAD_FAILURE;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret == LOAD_BADMACHO &amp;&amp; found_xhdr) &#123;</span><br><span class="line">        ret = LOAD_BADMACHO_UPX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kfree(addr, alloc_size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数较长。具体总结流程如下：</p>
<ol>
<li>进行加载之前的文件，参数，架构检测。</li>
<li><p>进入switch环节：</p>
<ol>
<li>只有深度为1的时候才执行<code>MH_EXECUTE</code>。  </li>
<li>只有深度为2的时候才执行<code>MH_DYLINKER</code>。  </li>
<li>其他的异常返回<code>LOAD_FAILURE</code>。  </li>
</ol>
</li>
<li><p>把所有指令都映射进内存。</p>
</li>
<li>根据<code>PIE</code>和<code>dyld</code>设置<code>ASLR</code>。  </li>
<li>进行3轮扫描</li>
<li>根据switch分支加载响应的动作。  <ol>
<li><code>LC_SEGMENT/LC_SEGMENT_64</code>：调用具体的 load_segment()。根据段指令将段直接映射进内存。</li>
<li><code>LC_UNIXTHREAD</code>：调用<code>load_unixthread()</code>。</li>
<li><code>LC_MAIN：调用<code>load_main()</code>。</code></li>
<li><code>LC_LOAD_DYLINKER</code>：如果在第3轮调且深度为1，则将命令保存到<code>dlp</code>变量中。</li>
<li><code>LC_UUID</code>：调用<code>load_uuid()</code>。将<code>UUID</code>复制到结果中。</li>
<li><code>LC_CODE_SIGNATURE</code>：调用<code>load_code_signature()</code>，只有第一趟扫描中。但是暂不验证。</li>
<li>还有一些其他的命令将会被忽略，由后面的<code>dylinker</code>来完成。</li>
</ol>
</li>
<li>这3趟循环结束之后，<code>dlp</code>变量中有一个保存的动态链接器命令。 将动态链接器加载到新的映射中，可能要根据ASLR进行调整，<code>load_dylinker</code> 函数会继续递归调用<code>parse_machfile</code></li>
</ol>
<p>至此。machO 已经被映射到内存中。接下来会在DYLD的流程中进行动态库的插入，加载，链接，及rebase。然后执行相关的初始化函数。最终返回main。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>app启动前发生的事情。</p>
<ol>
<li>由用户态触发进程创建。</li>
<li>通过系统调用执行内核创建进程。</li>
<li>读取镜像文件。加载header到内存</li>
<li>遍历excsw，执行对应的二进制格式加载逻辑</li>
<li>加载，解析对应的macho命令</li>
<li>保存dyld命令。</li>
<li>内核态完成。交由dyld进行动态库处理</li>
</ol>
<p><img src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/xcode_build/0F0459C5-134F-44BA-845D-57087593EDA8.png" alt="img"></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/xcode/" rel="tag"># xcode</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/25/深入理解iOS中的锁/" rel="next" title="深入理解iOS中的锁">
                <i class="fa fa-chevron-left"></i> 深入理解iOS中的锁
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://yfeii-blog.oss-cn-hangzhou.aliyuncs.com/profile/avatar.png" alt="yfeii">
            
              <p class="site-author-name" itemprop="name">yfeii</p>
              <div class="site-description motion-element" itemprop="description">邮箱1486662452@qq.com，有问题欢迎留言评论或邮件</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">14</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xcode-build"><span class="nav-number">2.</span> <span class="nav-text">xcode build</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#依赖的组成-来源"><span class="nav-number">3.</span> <span class="nav-text">依赖的组成(来源)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建优化"><span class="nav-number">4.</span> <span class="nav-text">构建优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#增量编译"><span class="nav-number">4.1.</span> <span class="nav-text">增量编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并行编译"><span class="nav-number">4.2.</span> <span class="nav-text">并行编译</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例"><span class="nav-number">5.</span> <span class="nav-text">案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#xcode-构建日志"><span class="nav-number">5.1.</span> <span class="nav-text">xcode 构建日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#headermap"><span class="nav-number">5.2.</span> <span class="nav-text">headermap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linkfilelist"><span class="nav-number">5.3.</span> <span class="nav-text">linkfilelist</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动"><span class="nav-number">6.</span> <span class="nav-text">启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程的创建"><span class="nav-number">6.1.</span> <span class="nav-text">进程的创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二进制文件的加载"><span class="nav-number">6.2.</span> <span class="nav-text">二进制文件的加载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mac-execve"><span class="nav-number">6.2.1.</span> <span class="nav-text">__\mac_execve</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exec-activate-image"><span class="nav-number">6.2.2.</span> <span class="nav-text">exec_activate_image</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exec-mach-imgact"><span class="nav-number">6.2.3.</span> <span class="nav-text">exec_mach_imgact</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#load-machfile"><span class="nav-number">6.2.4.</span> <span class="nav-text">load_machfile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#parse-machfile"><span class="nav-number">6.2.5.</span> <span class="nav-text">parse_machfile</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">6.3.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yfeii</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>



  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  

  

  
  

<script>
  var disqus_config = function() {
    this.page.url = "http://yfeii.github.io/2020/04/21/编译启动系列文章之xcode-build/";
    this.page.identifier = "2020/04/21/编译启动系列文章之xcode-build/";
    this.page.title = '从编译到启动';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-devyang-space.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    $(function() {
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll.disqus_scroll', function() {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('.disqus_scroll');
            loadComments();
          }
        });
      }
    });
  
</script>





  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
